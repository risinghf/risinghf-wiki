---
title: IoTSquare OpenAPI 文档
date: 2021-04-21 16:25:12
permalink: /01.api/10.iotsquare/02.IoTSquareOpenAPI/
---
# IoTSquare OpenAPI 文档

::: warning

本文档为 `IoTSquare` 高级 `API` 文档，包含应用、节点、网关、多播组管理接口

1. 接口以列表 `list` 创建 `create` 删除 `delete` 更新 `update` 状态 `status` 方式组织，部分接口可能只含有创建或删除

2. 统一使用 `JSON` 返回请求数据，其中最外层为 `code` `msg` `data`
	- `code` 包含响应码
	- `msg` 包含响应消息
	- `data` 字段包含本次请求的数据体

:::

::: details Changelog

- `v0.2` `2019-05-30` 第二次修订
  - 批量操作接口返回每个操作的节点、网关等的详细错误，包括：节点删除、应用删除、网关删除、多播组删除、多播组设备创建与删除等接口
  - 增加响应码附录
  - 包含分页的接口若未传分页参数，则默认取第一页，每页 `10` 个返回值
  - 增加推送链接说明，用户需要传带 `http://` 或 `https://` 前缀的推送链接

- `v0.1` `2019-05-05` 初稿

:::

## 1. 应用接口

::: warning

1. `IoTSquare` 以应用的形式来管理节点，需要先注册应用，再录入节点，建议同一应用下注册 `region` 及 `subnet` 相同的节点，以便后期维护

2. 当节点上行数据时 `IoTSquare` 会取应用的推送链接、请求头执行数据推送，用户可自定义最多 `5` 个 `HTTP` 请求头

3. 应用可选使用 `HTTP` 推送（`JSON`编码）接收数据或者使用 `MQTT`（`ProtocolBuffer`编码）接入 `IoTSquare` 订阅数据，若您未使用过 `MQTT` 与 `ProtocolBuffer` 则推荐优先使用 `HTTP` 推送获取数据

4. 配置推送链接后，若节点上行数据，会自动追加 `uplink` 与 `join` 子路径，分别用于推送节点应用层数据上行和节点入网成功消息

:::

### 1.1 应用列表

**URL：**`https://cloud.iotsquare.xyz/openapi/app/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|pageNo|int|分页页数|
|pageSize|int|分页大小|

::: warning

- `pageNo` 默认从 `1` 开始，`pageSize` 默认 `10`
- 当 `pageNo` 等于 `0` 且 `pageSize` 等于 `0` 时，将返回用户名下的所有应用（限制最多返回 `200` 条）

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|用户名下的应用总数|
|data|[]App|数据体，包含应用对象的数组|

**App：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用`ID`|
|appName|string|应用名称|
|pushURL|string|推送链接|
|enableMQTT|bool|是否启用`MQTT`|
|deviceNums|int|应用下的节点设备数量|
|createtime|int64|创建时间，单位为毫秒|
|updatetime|int64|更新时间，单位为毫秒|

**示例数据：**

**请求响应：**

``` json
{
	"code": 0,
	"msg": "ok",
	"amount": 4,
	"data": [{
		"appID": 89,
		"appName": "app_01",
		"pushURL": "https://iot.example.com/api/iotsquare",
		"enableMQTT": false,
		"deviceNums": 0,
		"createtime": 1556529353889,
		"updatetime": 1556529353889
	}, {
		"appID": 90,
		"appName": "app_02",
		"pushURL": "https://iot.example.com/api/iotsquare",
		"enableMQTT": false,
		"deviceNums": 0,
		"createtime": 1556529366216,
		"updatetime": 1556529366216
	}]
}
```

### 1.2 应用创建

**URL：**`https://cloud.iotsquare.xyz/openapi/app/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appName|string|应用名称|
|enableMQTT|bool|是否启用`MQTT`|
|pushURL|string|推送链接|
|headers|map|请求头|

::: warning

- 应用名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `enableMQTT` 表示是否开启 `MQTT` 功能，默认为 `false`
  - 若为 `false` 使用 `HTTP` 推送，节点数据为 `JSON` 格式编码
  - 若为 `true` 使用 `ProtocolBuffer` 编码节点数据，并通过 `MQTT` 协议发布

- `pushURL` 为推送链接，必须为带 `http://` 或者 `https://` 前缀的链接，假设配置链接为 `https://iot.example.com/api/iotsquare` `IoTSquare` 会分别追加 `uplink` 及 `join` 路径，分别用于推送节点应用层数据上行及节点 `join` 成功消息，如下所示
  - `https://iot.example.com/api/iotsquare/uplink`
  - `https://iot.example.com/api/iotsquare/join`

- `headers` 为用户自定义请求头部，默认为空，用户可配置 `x-access-token` `userID` 等，增加鉴权或自定义参数功能，每一个推送到用户 `CS` 的请求都将携带这些信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|appID|int|应用`ID`|

**示例数据：**

**请求参数：**

``` json
{
	"appName": "app_06",
	"pushURL": "https://iot.example.com/api/iotsquare",
	"enableMQTT": false,
	"headers": {
		"userID": "2333",
		"x-access-token": "6666"
	}
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"appID": 233
}
```

### 1.3 应用删除

**URL：**`https://cloud.iotsquare.xyz/openapi/app/delete`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appIDs|[]int|应用 `ID` 数组|

::: warning

- `IoTSquare` 支持批量删除应用
- 删除应用时，会删除应用下的全部节点，同时删除节点关联的数据上行、数据下行、多播组绑定关系等
- 若删除应用出错，会在 `data` 字段中包含每个异常 `appID` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|[]AppDeleteError|若出错，包含应用删除错误对象的数组|

**AppDeleteError：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|appID|int|应用 `ID` |

**示例数据：**

**请求参数：**

``` json
{
	"appIDs": [23, 233, 2333, 23333]
}
```

**请求响应：**

``` json
// 删除成功示例
{
	"code": 0,
	"msg": "ok"
}
// 删除出错示例，成功删除后两个应用，前两个出错，返回错误详细信息
{
	"code": 3003,
	"msg": "Application Batch Delete Error",
	"data": [{
			"code": 3001,
			"msg": "Application Not Exist",
			"appID": 23
		},
		{
			"code": 3001,
			"msg": "Application Not Exist",
			"appID": 233
		}]
}
```

### 1.4 应用更新

**URL：**`https://cloud.iotsquare.xyz/openapi/app/update`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用 `ID` |
|appName|string|应用名称|
|enableMQTT|bool|是否启用 `MQTT` |
|pushURL|string|推送链接|
|headers|map|请求头|

::: warning

- 应用名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `enableMQTT` 表示是否开启 `MQTT` 功能，默认为 `false`
  - 若为 `false` 使用 `HTTP` 推送，节点数据为 `JSON` 格式编码
  - 若为 `true` 使用 `ProtocolBuffer` 编码节点数据，并通过 `MQTT` 协议发布

- `pushURL` 为推送链接，假设链接为 `https://iot.example.com/api/iotsquare` `IoTSquare` 会分别追加 `uplink` 及 `join` 路径，分别用于推送节点应用层数据上行及节点 `join` 成功消息，如下所示
  - `https://iot.example.com/api/iotsquare/uplink`
  - `https://iot.example.com/api/iotsquare/join`

- `headers` 为用户自定义请求头部，默认为空，用户可配置 `x-access-token` `userID` 等，增加鉴权或自定义参数功能，每一个推送到用户 `CS` 的请求都将携带这些信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
{
	"appName": "app_06",
	"pushURL": "https://iot.example.com/api/iotsquare",
	"enableMQTT": false,
	"headers": {
		"userID": "2333",
		"x-access-token": "6666"
	}
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 1.5 应用状态

**URL：**`https://cloud.iotsquare.xyz/openapi/app/status`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用 `ID` |

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|AppStatus|应用状态对象|

**AppStatus：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用 `ID` |
|appName|string|应用名称|
|pushURL|string|推送链接|
|headers|map|请求头|
|enableMQTT|bool|是否启用 `MQTT` |
|deviceNums|int|应用下的节点设备数量|
|createtime|int64|创建时间，单位为毫秒|
|updatetime|int64|更新时间，单位为毫秒|

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"data": {
		"appID": 89,
		"appName": "app_01",
		"pushURL": "https://iot.example.com/api/iotsquare",
		"headers": {
			"userID": "2333",
			"x-access-token": "6666"
		},
		"enableMQTT": false,
		"deviceNums": 0,
		"createtime": 1556529353889,
		"updatetime": 1556532306098
	}
}
```

## 2. 节点接口

::: warning

1. `IoTSquare` 线上环境当前预置了以下区域和子网供测试
   - `CN470` `CH_00-07`
   - `CN470PREQUEL` `CH_00-07`
   - `EU868` `CH_00-07`
   - `AS923` `CH_00-07`
   - `US915` `CH_00-07_64`
   - `EU433` `CH_00-07`
   - `AU915` `CH_00-07_64`
   - `IN865` `CH_00-07`

2. 每个区域有各自的 `ClassA/B/C` 默认参数，同一区域下的子网除频段范围不同外，其他参数相同

3. 子网 `CH_00-07` 表示使用编号 `00-07` 的信道，子网 `CH_00-07_64` 表示使用编号 `00~07` 及 `64` 的信道，以此类推

4. 部分频段具有较多的信道数，要确保节点正常通信，要求保证网关、节点及 `NS` 参数一致，因此 `IoTSquare` 预设了一些默认
频段同步到各个组件，以便用户可以快速上手

5. 所有节点默认支持A类工作模式，即节点上行一帧数据后，后续打开两个接收窗口，接收服务端数据下发

6. 在 `A` 类工作模式基础上，可配置节点支持 `B` 类或 `C` 类的工作模式
   - `ClassB`：需要网关启用 `GPS` 节点成功切换到 `ClassB` 后，将定时主动开启 `B` 类接收窗口，接收服务端数据下发
   - `ClassC`：除 `A` 类上行数据及后续两个接收窗口的时间外，保持打开 `C` 类接收窗口，随时接收服务端数据下发

:::

### 2.1 列表节点

**URL：**`https://cloud.iotsquare.xyz/openapi/device/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用 `ID` |
|pageNo|int|分页页数|
|pageSize|int|分页大小|

::: warning

- `appID` 为应用 `ID` 必传
- `pageNo` 默认从 `1` 开始 `pageSize` 默认 `10`
- 当 `pageNo` 等于 `0` 且 `pageSize` 等于 `0` 时，将返回应用下的所有节点（限制最多返回 `200` 条）

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|当前应用下的设备总数|
|data|[]Device|数据体，包含节点对象的数组|

**Device：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|
|devName|string|节点名称称|
|region|string|节点所属区域|
|fCnt|int|节点上行帧计数器|
|fPort|int|节点通信端口|
|lastSeen|int64|最后通信时间，单位为毫秒|

::: warning

- `fCnt` `lastSeen` 分别取自最新一帧节点上行数据
- `lastSeen` 为 `Unix` 时间戳，但精度取到毫秒级，若节点未通信过，固定返回 `-1`
- `fPort` 取最新一帧包含 `Payload` 的节点上行数据

:::

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"amount": 4,
	"data": [{
		"devEUI": "b0cf5e634ec6d815",
		"devName": "device_01",
		"devAddr": "1d72ffc0",
		"region": "eu868",
		"fCnt": 3,
		"fPort": 8,
		"lastSeen": 1556532306098
	}, {
		"devEUI": "55e1032590dc5682",
		"devName": "device_02",
		"devAddr": "5d71f5cd",
		"region": "eu868",
		"fCnt": 0,
		"fPort": 0,
		"lastSeen": -1
	}]
}
```

### 2.2 节点创建

**URL：**`https://cloud.iotsquare.xyz/openapi/device/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|appID|int|应用 `ID` |
|devName|string|节点名称|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|
|appEUI|string| `16` 位 `16` 进制符串，节点应用唯一标识符|
|region|string|节点所属区域|
|subnet|string|节点所属子网|
|supportClassB|bool|节点是否支持 `classB`|
|supportClassC|bool|节点是否支持 `classC`|
|authType|string|认证类型，可选 `abp` 或 `otaa`|
|appKey|string| `32` 位 `16` 进制字符串 `otaa` 入网必填|
|devAddr|string| `8` 位 `16` 进制字符串 `abp` 入网必填|
|appSKey|string| `32` 位 `16` 进制字符串 `abp` 入网必填|
|nwkSKey|string| `32` 位 `16` 进制字符串 `abp` 入网必填|
|macVersion|string| `LoRaWAN` 协议版本,可选 `1.0.2` 或 `1.0.3` 默认为 `1.0.2`|

::: warning

- 节点名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `region` 及 `subnet` 表示节点所属的区域与子网，`IoTSquare` 针对每个区域提供了一套默认配置，需要确保节点、网关、服务端一致才能正常通信

- 所有节点默认支持 `classA` 此时可选支持 `classB` 或 `classC` 但不能同时勾选，因为节点无法同时工作在 `B` 类与 `C` 类模式下
  - **classA：**`supportClassB=false` `supportClassC=false`
  - **classB：**`supportClassB=true` `supportClassC=false`
  - **classC：**`supportClassB=false` `supportClassC=true`

- `authType` 可选 `abp` 或 `otaa`
  - **abp：** 用户必须填写 `devAddr` `appSKey` `nwkSKey` 节点无需 `join` 服务端将验证 `devAddr` + `nwkSKey` 的组合是否有重复
  - **otaa：** 用户必须填写 `appKey` 节点 `join` 成功后将自动生成 `devAddr` `appSKey` `nwkSKey`

- `macVersion` 可选 `1.0.2` 或 `1.0.3` 支持 `1.0.3` 的节点在 `OTAA` 入网时 `JoinAccept` 消息会携带 `ChannelMask` 同步信道 `US915` `AU915` `CN470` 等标准频率计划支持该特性

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
// OTAA入网
{
	"appID": 89,
	"supportClassB": false,
	"supportClassC": true,
	"devEUI": "55e1032590dc5682",
	"appEUI": "fbd11efce114c519",
	"devName": "device_02",
	"region": "eu868",
	"subnet": "ch_00-07",
	"authType": "otaa",
	"appKey": "a14e7a59f879d32a47d1c0825bdcfe0b",
	"macVersion":"1.0.2"
}
// ABP入网
{
	"appID": 89,
	"supportClassB": false,
	"supportClassC": true,
	"devEUI": "dafc73e93941defa",
	"appEUI": "2536e67b3ca8906d",
	"devName": "device_04",
	"region": "eu868",
	"subnet": "ch_00-07",
	"authType": "abp",
	"appSKey": "9ac5bcb434d8a4d6e67b3dec60ce5f84",
	"nwkSKey": "678211ee2b22b3bf216f28296e3eb67b",
	"devAddr": "5d71f5cd",
	"macVersion":"1.0.2"
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 2.3 节点删除

**URL：**`https://cloud.iotsquare.xyz/openapi/device/delete`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUIs|[]string| `devEUI` 数组|

::: warning

- `IoTSquare` 支持批量删除节点
- 删除节点时，同时删除节点关联的数据上行、数据下行、多播组绑定关系等
- 若删除节点出错，会在 `data` 字段中包含每个异常 `devEUI` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|[]DeviceDeleteError|若出错，包含节点删除错误对象的数组|

**DeviceDeleteError：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|

**示例数据：**

**请求参数：**

```json
{
	"devEUIs": ["b0cf5e634ec6d815", "55e1032590dc5682", "0f475d71f5cd2f20", "84955e634ec6d815"]
}
```

**请求响应：**

```json
// 成功删除示例
{
	"code": 0,
	"msg": "ok"
}
// 删除出错示例，部分节点删除失败
{
    "code": 4006,
    "msg": "Device Batch Delete Error",
    "data": [
        {
            "code": 4001,
            "msg": "Device Not Exist",
            "devEUI": "0f475d71f5cd2f20"
        },
        {
            "code": 4001,
            "msg": "Device Not Exist",
            "devEUI": "84955e634ec6d815"
        }
    ]
}
```

### 2.4 节点更新

**URL：**`https://cloud.iotsquare.xyz/openapi/device/update`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|
|devName|string|节点名称|

::: warning

- 由于节点包含大量参数配置，改动参数可能造成节点无法正常工作，目前 `IoTSquare` 只支持更改节点名称，若需要变更节点配置，请先删除节点，然后使用新参数重新录入，再验证节点是否可以 `join` 或正常上行数据
- 节点名称限制使用字母及下划线组成，长度不超过 `20` 个字符

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
{
	"devEUIs": "b0cf5e634ec6d815",
	"devName": "node_2333"
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 2.5 节点状态

**URL：**`https://cloud.iotsquare.xyz/openapi/device/status`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|DeviceStaus|节点状态对象|

**DeviceStaus：**

|字段名|类型|描述|
|:---|:---|:---|
|devName|string|节点名称|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|
|appEUI|string| `16` 位 `16` 进制符串，节点应用唯一标识符|
|region|string|节点所属区域|
|subnet|string|节点所属子网|
|supportClassB|bool|节点是否支持 `classB`|
|supportClassC|bool|节点是否支持 `classC`|
|authType|string|认证类型 `abp` 或 `otaa`|
|appKey|string| `appKey` `32` 位 `16` 进制字符串|
|devAddr|string| `devAddr` `8` 位 `16` 进制字符串|
|appSKey|string| `appSKey` `32` 位 `16` 进制字符串|
|nwkSKey|string| `nwkSKey` `32` 位 `16` 进制字符串|

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"data": {
		"devEUI": "90b96dadce96a06a",
		"appEUI": "526973696e674846",
		"devName": "device_01",
		"authType": "otaa",
		"region": "eu868",
		"subnet": "ch_00-07",
		"devAddr": "12ef4567",
		"appKey": "6b7e151628aed2a6abf7158809cf4f3c",
		"appSKey": "0bf7158809cf4f3cb7e151628aed2a6a",
		"nwkSKey": "28aed2a6abf7158809cf2b7e15164f3c",
		"supportClassB": false,
		"supportClassC": true,
		"createtime": 1556522944593
	}
}
```

## 3. 节点数据下行接口

::: warning

1. `IoTSquare` 使用先入先出队列来存储节点的应用层数据下行队列，每一个节点对应一个下行队列，节点工作在 `Class A/B/C` 时，下行数据都取自同一个队列，若同时出现 `A` 类上行与 `B/C` 类主动下行，优先让 `A` 类上行从队列获取获取数据
   - 对于 `ClassA` 下行数据将会在节点上行时捎带，节点将会在发送数据后的两个接收窗口中收到数据
   - 对于 `ClassB` 除 `A` 类上行捎带数据外 `IoTSquare` 会定时扫描节点下行队列，取 `GPS` 时间戳未超时的队列数据主动下发，节点将会在定时开启的B类接收窗口中收到数据
   - 对于 `ClassC` 除 `A` 类上行稍带数据外 `IoTSquare` 会定时扫描节点下行队列，在避开节点 `A` 类的两个接收窗口情况下，主动下发，节点将会在开启的 `C` 类接收窗口中收到数据

2. 由于使用了队列的结构 `IoTSquare` 可以缓存下行数据，但对于 `otaa` 节点，重新 `join` 时，节点通信密钥自动变更，此时将清空下行队列

3. 节点在通信过程中，数据速率会产生变化，间接影响到可下发的数据包长度，要保证下行数据不超过当前速率限定长度
	- 对于 `ClassA` 可使用节点最新一帧数据的速率结合频率区域计算，获取可下发的最大数据长度
	- 对于 `ClassB` 及 `ClassC` `LoRaWAN` 协议固定了数据速率，需要取节点对应频率区域的 `B` 类或 `C` 类参数来计算可下发的最大数据长度

:::

### 3.1 数据下行创建

**URL：**`https://cloud.iotsquare.xyz/openapi/devicedl/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string| `16` 位 `16` 进制符串，节点设备唯一标识符|
|fPort|int|节点通信端口|
|data|string| `base64` 编码的数据字符串|
|confirmed|bool|是否为确认下行|

::: warning

- `fPort` 取值为 `1~199` `201~223` 其余端口为 `LoRaWAN` 协议预留端口

- `data` 为 `base64` 编码的数字字符串 `IoTSquare` 将对该数值解 `base64` 后以二进制格式组帧再下发至节点
  - 若原始数据为 `16` 进制数据，例如 `0x2333` 长度为两个字节 `base64` 编码后的数据为 `IzM=`
  - 若原始数据为 `ASCII` 字符串，例如 `2333` 长度为四个字节 `base64` 编码后的数据为 `MjMzMw==`

- `confirmed` 表示对应下行数据包是否为确认下行，节点收到后会在下一帧上行中将确认回复位值 `1`,`confirmed` 默认为 `false` 使用非确认下行

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|fCnt|int|本次数据下发对应的下行帧计数器|

::: warning

- 每一个节点都维护了一对上行帧计数器和下行帧计数器，调用数据下行接口返回的 `fCnt` 为本次数据下发对应的下行帧计数器编号

:::

**示例数据：**

**请求参数：**

```json
// 原始数据为 16 进制 0x2333 长度为两个字节
{
	"devEUI": "b0cf5e634ec6d815",
	"fPort": 8,
	"data": "IzM=",
	"confirmed": false
}
// 原始数据为 ASCII 字符串 2333 长度为四个字节
{
	"devEUI": "b0cf5e634ec6d815",
	"fPort": 8,
	"data": "MjMzMw==",
	"confirmed": false
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"fCnt": 6666
}
```

## 4. 网关接口

::: warning

1. `IoTSquare` 支持网关以 `UDP` 或 `MQTT` 协议连接到服务器

2. 网关使用 `UDP` 连接时，由 `pktfwd` 直接与服务器通信，网关在线状态也由 `UDP` 连接状态判断

3. 网关使用 `MQTT` 连接时，由网关 `SDK` 与服务器通信，此时可以获得更多高级功能，包括网关网络状态、系统状态等，网关录入 `IoTSquare` 并成功连接到服务器后，将根据录入的网关类型自动配置 `pktfwd` 频率计划等

4. 网关可用区域子网参考节点配置

5. 目前可用网关型号如下
   - `RHF2S208`
   - `RHF2S208F`
   - `RHF2S024`
   - `RHF2S025`

6. 网关型号默认为半双工网关，带 `f` 后缀（如 `RHF2S208F` ）的表示为全双工网关

:::

### 4.1 网关列表

**URL：**`https://cloud.iotsquare.xyz/openapi/gateway/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|pageNo|int|分页页数|
|pageSize|int|分页大小|

::: warning

- `pageNo` 默认从 `1` 开始 `pageSize` 默认 `10`
- 当 `pageNo` 等于 `0` 且 `pageSize` 等于 `0` 时，将返回用户名下的所有网关（限制最多返回 `200` 条）

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|用户名下的网关总数|
|data|[]Gateway|数据体，包含网关对象的数组|

**Gateway：**

|字段名|类型|描述|
|:---|:---|:---|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|
|gwName|string|网关名称|
|gwType|string|网关类型|
|region|string|网关所属区域|
|online|bool|网关是否在线|
|createtime|int64|创建时间，单位为毫秒|
|lastSeen|int64|最后通信时间，单位为毫秒|

::: warning

- 网关在线状态取自 `pktfwd` 或网关 `SDK` 连接状态
- `lastSeen` 为 `Unix` 时间戳，但精度取到毫秒级，若网关未通信过，固定返回 `-1`

:::

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"amount": 3,
	"data": [{
		"gwID": "31b977fffe398501",
		"gwName": "gateway_01",
		"gwType": "rhf2s208",
		"region": "cn470",
		"online": false,
		"createtime": 1557020283245,
		"lastSeen": -1
	}, {
		"gwID": "d58158fffe83fd51",
		"gwName": "gateway_02",
		"gwType": "rhf2s208",
		"region": "au915",
		"online": false,
		"createtime": 1557020300856,
		"lastSeen": -1
	}]
}
```

### 4.2 网关创建

**URL：**`https://cloud.iotsquare.xyz/openapi/gateway/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|
|gwName|string|网关名称|
|gwType|string|网关类型|
|region|string|网关所属区域|
|subnet|string|网关所属子网|
|enableClassB|bool|是否启用 `ClassB` 支持|
|enablePFW|bool|是否启用 `pktfwd` |

::: warning

- 网关名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `enableClassB` 表示是否开启 `ClassB` 支持，需要安装网关 `SDK` 且配置 `GPS` 的网关才可以支持，默认为 `false`
  - 若为 `false` 网关不启用 `ClassB` 支持，只作为数据包时间源使用
  - 若为 `true` 网关启用 `ClassB` 支持，开启对应区域、子网的 `Beacon` 对时广播

- `enablePFW` 表示是否启用 `pktfwd` 需要安装网关 `SDK` 才可以支持，默认为 `true`
  - 若为 `false` 网关 `SDK` 不启用 `pktfwd` 只作为远程管理工具运行
  - 若为 `true` 网关 `SDK` 将启用 `pktfwd` 维护 `pktfwd` 的运行、自动重启、配置同步等

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
{
	"gwID": "d58158fffe83fd51",
	"gwName": "gateway_02",
	"region": "au915",
	"gwType": "rhf2s208",
	"subnet": "ch_00-07_64",
	"enableClassB": false,
	"enablePFW": true
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 4.3 网关删除

**URL：**`https://cloud.iotsquare.xyz/openapi/gateway/delete`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|gwIDs|[]int|网关 `ID` 数组|

::: warning

- `IoTSquare` 支持批量删除网关
- 删除网关时，会同时删除网关关联的数据上行、数据下行等，并关闭网关上的 `pktfwd` 程序
- 若删除网关出错，会在 `data` 字段中包含每个异常 `gwID` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|[]GatewayDeleteError|若出错，包含网关删除错误对象的数组|

**GatewayDeleteError：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|

**示例数据：**

**请求参数：**

```json
{
	"gwIDs": ["d58158fffe83fd51", "31b977fffe398501"]
}
```

**请求响应：**

```json
// 成功删除示例
{
	"code": 0,
	"msg": "ok"
}
// 删除出错示例，部分网关不存在
{
    "code": 5006,
    "msg": "Gateway Batch Delete Error",
    "data": [
        {
            "code": 5001,
            "msg": "Gateway Not Exist",
            "gwID": "d58158fffe83fd51"
        },
        {
            "code": 5001,
            "msg": "Gateway Not Exist",
            "gwID": "31b977fffe398501"
        }
    ]
}
```

### 4.4 网关更新

**URL：**`https://cloud.iotsquare.xyz/openapi/gateway/update`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|
|gwName|string|网关名称|
|gwType|string|网关类型|
|enableClassB|bool|是否启用 `ClassB` 支持|
|enablePFW|bool|是否启用 `pktfwd`|

::: warning

- 网关名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `enableClassB` 表示是否开启 `ClassB` 支持，需要安装网关 `SDK` 且配置 `GPS` 的网关才可以支持，默认为 `false`
  - 若为 `false` 网关不启用 `ClassB` 支持，只作为数据包时间源使用
  - 若为 `true` 网关启用 `ClassB`支持，开启对应区域、子网的 `Beacon` 对时广播

- `enablePFW` 表示是否启用 `pktfwd` 需要安装网关 `SDK` 才可以支持，默认为 `true`
  - 若为 `false` 网关 `SDK` 不启用 `pktfwd` 只作为远程管理工具运行
  - 若为 `true` 网关 `SDK` 将启用 `pktfwd` 维护 `pktfwd` 的运行、自动重启、配置同步等

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

``` json
{
	"gwID": "31b977fffe398501",
	"gwName": "gateway_01",
	"gwType": "rhf2s208",
	"enableClassB": true,
	"enablePFW": true
}
```

**请求响应：**

``` json
{
	"code": 0,
	"msg": "ok"
}
```

### 4.5 网关状态

**URL：**`https://cloud.iotsquare.xyz/openapi/gateway/status`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|GatewayStatus|网关状态对象|

**GatewayStatus：**

|字段名|类型|描述|
|:---|:---|:---|
|gwID|string|网关 `ID` `16` 位 `16` 进制符串，网关唯一标识符|
|gwName|string|网关名称|
|gwType|string|网关类型|
|region|string|网关所属区域|
|subnet|string|网关所属子网|
|online|bool|网关是否在线|
|enableClassB|bool|是否启用 `ClassB` 支持|
|enablePFW|bool|是否启用 `pktfwd`|
|mqtt|bool|网关是否以 `MQTT` 方式接入服务器|
|altitude|float|海拔，需要带 `GPS` 的网关|
|latitude|float|纬度，需要带 `GPS` 的网关|
|longitude|float|经度，需要带 `GPS` 的网关|
|createtime|int64|创建时间，单位为毫秒|

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"data": {
		"gwID": "31b977fffe398501",
		"gwName": "gateway_01",
		"gwType": "rhf2s208",
		"enableClassB": true,
		"enablePFW": true,
		"region": "cn470",
		"subnet": "ch_00-07",
		"online": false,
		"mqtt": false,
		"latitude": 0,
		"longitude": 0,
		"altitude": 0,
		"createtime": 1557020283245
	}
}
```

## 5. 多播组

::: warning

多播，英语：`multicast` 台湾又译作多点发送、多点广播或群播，中国大陆又译作组播，以下文档描述中，将统一使用多播

:::

### 5.1 单播 vs 多播 vs 广播

::: warning

为了简化概念，这里以节点数据下发来阐述单播、多播、广播，假设一批节点处于 `ClassC` 状态下，需要对它们发送数据

- 单播：对每个节点单独发送数据下行，此时 `iotsqaure` 到节点的路由取节点最新一帧数据上行中的网关，若有 `N` 个节点，需要发送 `N` 次，效率较低

- 广播：不加计算，使用多播地址组帧，对系统内在线的所有网关下发一次数据，若有 `M` 个网关，需要发送 `M` 次，效率最低

- 多播：取这一批节点的上行网关历史，由此计算出 `iotsqaure` 到达全部节点所需的最少网关数量，而后使用多播地址组帧，对计算出的每一个网关发送一次数据下行，理想情况下，若这批节点通过一个网关上行数据，那么只需发送一次，效率最高

:::

### 5.2 单播地址 vs 多播地址

::: warning

- 单播地址：`abp` 节点手动设备的 `devAddr` 或 `otaa` 节点 `join` 成功后分配的 `devAddr`

- 多播地址：使用 `at+lw=mc` 手动配置的 `mcAddr` 或使用多播协议自动生成的 `mcAddr`

:::

### 5.3 手动配置多播 vs 自动配置多播

::: warning

- `LoRaWAN` 协议定义了一套基于应用层的多播控制协议，需要节点、服务器同时支持，以类似 `otaa` 入网的方式，需要有一个同步过程，从服务器获取动态分配的多播地址、密钥配置节点，提供多播功能

- 瑞兴恒方在标准协议外，增加了手动配置多播地址功能，允许以类似 `abp` 入网的方式，无需从服务器同步参数，直接通过 `at` 指令配置 `mcAddr` `mcAppSKey` `mcNwkSKey` 提供多播功能

:::

### 5.4 多播拓展功能

::: warning

- 瑞兴恒方在 `LoRaWAN` 多播协议基础上，开发了多播拓展功能。当多播组同时启用自动控制与拓展功能时，限制组内设备数量最大为 `253` 个，用户的多播数据下发将特殊处理，由 `IoTSquare` 进行一轮或多轮数据下行，并获取成功响应的设备数量，处理结束后，使用 `HTTP` 推送或 `MQTT` 发布下行结果

:::

### 5.5 多播组的使用方式

::: warning

1. 每个多播组只允许添加具有相同 `region` `subnet` 的节点，目前支持 `ClassC` 节点

2. 节点需要先录入应用，然后再录入多播组

3. 手动配置多播支持一个多播地址，自动配置多播最多支持四个多播地址

:::

## 6. 多播组接口

### 6.1 多播组列表

**URL：**`https://cloud.iotsquare.xyz/openapi/mcgroup/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|pageNo|int|分页页数|
|pageSize|int|分页大小|

::: warning

- `pageNo` 默认从 `1` 开始 `pageSize` 默认 `10`
- 当 `pageNo` 等于 `0` 且 `pageSize` 等于 `0` 时，将返回用户名下的所有网关（限制最多返回 `200` 条）

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|用户名下的多播组总数|
|data|[]MCGroup|数据体，包含多播组对象的数组|

**MCGroup：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|
|mcName|string|多播组名称|
|region|string|多播组所属区域|
|subnet|string|多播组所属子网|
|groupID|string|多播组分组 `ID` |
|deviceNums|int|多播组下的节点设备数量|
|pushURL|string|推送链接|
|enableMQTT|bool|是否启用 `MQTT` |
|createtime|int64|创建时间，单位为毫秒|

::: warning

- `region` `subnet` 参数参考节点介绍章节

- 若启用自动配置多播 `groupID` 取值 `0~3` 若使用手动配置多播 `groupID` 默认为 `256`

:::

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"amount": 2,
	"data": [{
		"mcEUI": "778327e60a028072",
		"mcName": "mc_nodes_00",
		"region": "eu868",
		"subnet": "ch_00-07",
		"groupID": 0,
		"pushURL": "https://iot.example.com/api/iotsquare",
		"enableMQTT": false,
		"deviceNums": 50,
		"createtime": 1556283852576
	}, {
		"mcEUI": "e6a98ae25d7db6f8",
		"mcName": "mc_nodes_01",
		"region": "eu868",
		"subnet": "ch_00-07",
		"groupID": 256,
		"pushURL": "",
		"enableMQTT": false,
		"deviceNums": 0,
		"createtime": 1556611552899
	}]
}
```

### 6.2 多播组创建

**URL：**`https://cloud.iotsquare.xyz/openapi/mcgroup/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|
|mcName|string|多播组名称|
|region|string|多播组所属区域|
|subnet|string|多播组所属子网|
|class|string|多播组支持的节点类型，目前支持 `B` 或 `C` 类多播，字母需大写|
|pingSlotPeriod|int|多播组 `pingSlot` 长度，单位为秒，必须为 `2` 的N次方，可取 `1~128` 间的数值 `B` 类多播组必填|
|enableMCRemote|bool|是否开启多播自动配置|
|groupID|int|多播分组 `ID` 若开启多播自动配置，可选 `0~3` 多播自动配置必填|
|enableMCExt|bool|是否开启多播拓展功能，若开启，限制多播组内节点设备数量最多 `253` 个|
|timeSlotLength|int|时间片长度，可选 `0~15` 多播拓展功能必填|
|genAppKey|string| `32` 位 `16` 进制字符串，多播自动配置必填|
|mcAddr|string| `8` 位 `16` 进制字符串，手动配置多播必填|
|mcAppSKey|string| `32` 位 `16` 进制字符串，手动配置多播必填|
|mcNwkSKey|string| `32` 位 `16` 进制字符串，手动配置多播必填|
|enableMQTT|bool|是否启用 `MQTT` 手动配置多播必填|
|pushURL|string|推送链接，多播自动配置必填|
|headers|map|请求头，多播自动配置选填|

::: warning

- 多播组名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- `enableMCRemote` 表示是否启用多播自动配置，默认为 `false`
  - 若为 `false` 用户必须填写 `mcAddr` `mcAppSKey` `mcNwkSKey` 服务端将验证 `mcAddr` + `mcNwkSKey` 的组合是否有重复
  - 若为 `true` 用户必须填写 `genAppKey` `groupID` 节点将通过多播协议获取 `mcAddr` `mcAppSKey` `mcNwkSKey` `groupID`

- `enableMQTT` 表示是否开启 `MQTT` 功能，默认为 `false`
  - 若为 `false` 使用 `HTTP` 推送，节点数据为 `JSON` 格式编码
  - 若为 `true` 使用 `ProtocolBuffer` 编码节点数据，并通过 `MQTT` 协议发布

- `pushURL` 为推送链接，开启拓展功能后 `IoTSquare` 对用户的每次数据下行结果进行推送，假设配置链接为 `https://iot.example.com/api/iotsquare` `IoTSquare` 会追加 `multicast` 路径用于推下行结果，如下所示
  - `https://iot.example.com/api/iotsquare/multicast`

- `headers` 为用户自定义请求头部，默认为空，用户可配置 `x-access-token` `userID` 等，增加鉴权或自定义参数功能，每一个推送到用户 `CS` 的请求都将携带这些信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
// B类多播组启用多播自动配置且启用多播拓展功能
{
	"mcName": "mc_group_00",
	"mcEUI": "f7d96c075a6d0154",
	"region": "eu868",
	"subnet": "ch_00-07",
	"class": "B",
	"pingSlotPeriod": 32,
	"enableMCRemote": true,
	"groupID": 0,
	"genAppKey": "504e83e6dd1a457af1bf93f99d362e89",
	"enableMCExt": true,
	"timeSlotLength": 0,
	"enableMQTT": false,
	"pushURL": "https://test.example.com/api/iotsquare",
	"headers": {
		"userID": "2333",
		"x-access-token": "6666"
	}
}
// B类多播组启用手动配置多播
{
	"mcName": "mc_group_02",
	"mcEUI": "0abe5ddf92cff537",
	"region": "eu868",
	"subnet": "ch_00-07",
	"class": "B",
	"pingSlotPeriod":32,
	"enableMCRemote": false,
	"mcAddr": "45c325ce",
	"mcAppSKey": "a1ef710bb888c7f0d1a296a442203fb8",
	"mcNwkSKey": "868d85d136e7006619c6910aaf3e488e"
}
// C类多播组启用多播自动配置且启用多播拓展功能
{
	"mcName": "mc_group_00",
	"mcEUI": "f7d96c075a6d0154",
	"region": "eu868",
	"subnet": "ch_00-07",
	"class": "C",
	"enableMCRemote": true,
	"groupID": 0,
	"genAppKey": "504e83e6dd1a457af1bf93f99d362e89",
	"enableMCExt": true,
	"timeSlotLength": 0,
	"enableMQTT": false,
	"pushURL": "https://test.example.com/api/iotsquare",
	"headers": {
		"userID": "2333",
		"x-access-token": "6666"
	}
}
// C类多播组启用手动配置多播
{
	"mcName": "mc_group_02",
	"mcEUI": "0abe5ddf92cff537",
	"region": "eu868",
	"subnet": "ch_00-07",
	"class": "C",
	"enableMCRemote": false,
	"mcAddr": "45c325ce",
	"mcAppSKey": "a1ef710bb888c7f0d1a296a442203fb8",
	"mcNwkSKey": "868d85d136e7006619c6910aaf3e488e"
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 6.3 多播组删除

**URL：**`https://cloud.iotsquare.xyz/openapi/mcgroup/delete`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUIs|[]string| `mcEUI` 数组|

::: warning

- `IoTSquare` 支持批量删除多播组

- 删除多播组时，会解除多播组下的全部节点与该多播组的绑定

- 若删除多播组出错，会在 `data` 字段中包含每个异常 `mcEUI` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|[]MCGroupDeleteError|若出错，包含多播组删除错误对象的数组|

**MCGroupDeleteError：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|

**示例数据：**

**请求参数：**

```json
{
	"mcEUIs": ["ec6d815b0cf5e634", "32590dc55e105682", "75d71f50f4cd2f20", "5e634ec6d8495815"]
}
```

**请求响应：**

```json
// 成功删除示例
{
	"code": 0,
	"msg": "ok"
}
// 删除出错示例，部分多播组删除失败
{
    "code": 14007,
    "msg": "MCGroup Batch Delete Error",
    "data": [
        {
            "code": 14001,
            "msg": "MCGroup Not Exist",
            "mcEUI": "32590dc55e105682"
        },
        {
            "code": 14001,
            "msg": "MCGroup Not Exist",
            "mcEUI": "75d71f50f4cd2f20"
        }
    ]
}
```

### 6.4 多播组更新

**URL：**`https://cloud.iotsquare.xyz/openapi/mcgroup/update`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|
|mcName|string|多播组名称|
|timeSlotLength|int|时间片长度，可选 `0~15` 多播拓展功能必填|
|mcAddr|string| `8` 位 `16` 进制字符串，手动配置多播必填|
|mcAppSKey|string| `32` 位 `16` 进制字符串，手动配置多播必填|
|mcNwkSKey|string| `32` 位 `16` 进制字符串，手动配置多播必填|
|enableMQTT|bool|是否启用 `MQTT` 手动配置多播必填|
|pushURL|string|推送链接，多播自动配置必填|
|headers|map|请求头|

::: warning

- 多播组名称限制使用字母及下划线组成，长度不超过 `20` 个字符

- 若关闭多播自动配置，用户可更新 `mcAddr` `mcAppSKey` `mcNwkSKey` 服务端将验证 `mcAddr` + `mcNwkSKey` 的组合是否有重复

- 若启用多播自动配置与拓展功能，用户可更新 `timeSlotLength`

- `enableMQTT` 表示是否开启 `MQTT` 功能，默认为 `false`
  - 若为 `false`使用 `HTTP` 推送，节点数据为 `JSON` 格式编码
  - 若为 `true` 使用 `ProtocolBuffer` 编码节点数据，并通过 `MQTT` 协议发布

- `pushURL` 为推送链接，开启拓展功能后 `IoTSquare` 对用户的每次数据下行结果进行推送，假设配置链接为 `https://iot.example.com/api/iotsquare` `IoTSquare` 会追加 `multicast` 路径用于推下行结果，如下所示
  - `https://iot.example.com/api/iotsquare/multicast`

- `headers` 为用户自定义请求头部，默认为空，用户可配置 `x-access-token` `userID` 等，增加鉴权或自定义参数功能，每一个推送到用户 `CS` 的请求都将携带这些信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
// 开启多播自动配置且开启拓展功能
{
	"mcEUI": "ef9a560aba9c3d7d",
	"mcName": "mc_group_02",
	"pushURL": "https://test.example.com/api/iotsquare",
	"enableMQTT": false,
	"headers": {
		"x-access-token": "6666",
		"userID": "2333"
	},
	"timeSlotLength": 3
}
// 手动配置多播
{
	"mcEUI": "a0891ce817397ee8",
	"mcName": "mc_group_03",
	"mcAddr": "75bacecd",
	"mcAppSKey": "a32da0c03d3ab55e5be1dcc60f777481",
	"mcNwkSKey": "c013d964a16c9ee761cfd295614acf17"
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```

### 6.5 多播组状态

**URL：**`https://cloud.iotsquare.xyz/openapi/mcgroup/status`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|MCGroupStaus|多播组状态对象|

**MCGroupStaus：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|
|mcName|string|多播组名称|
|region|string|多播组所属区域|
|subnet|string|多播组所属子网|
|class|string|多播组支持的节点类型|
|enableMCRemote|bool|是否开启多播自动配置|
|groupID|int|多播分组 `ID` |
|enableMCExt|bool|是否开启多播拓展功能|
|timeSlotLength|int|时间片长度|
|genAppKey|string| `32` 位 `16` 进制字符串|
|mcAddr|string| `8` 位 `16` 进制字符串|
|mcAppSKey|string| `32` 位 `16` 进制字符串|
|mcNwkSKey|string| `32` 位 `16` 进制字符串|
|deviceSetup|int|多播组下已同步的节点设备数量|
|deviceNums|int|多播组下的节点设备数量|
|pushURL|string|推送链接|
|enableMQTT|bool|是否启用 `MQTT`|
|updatetime|int64|更新时间，单位为毫秒|
|createtime|int64|创建时间，单位为毫秒|

**示例数据：**

**请求响应：**

```json
// 开启多播自动配置且开启拓展功能
{
	"code": 0,
	"msg": "ok",
	"data": {
		"mcEUI": "6f655b6ffe9c25ca",
		"mcName": "mc_group_01",
		"region": "eu868",
		"subnet": "ch_00-07",
		"class": "C",
		"pingSlotPeriod": 0,
		"enableMCRemote": true,
		"groupID": 3,
		"genAppKey": "c6a1f7c9c9db0f4536be3de8327ef57b",
		"enableMCExt": false,
		"timeSlotLength": 3,
		"mcAddr": "0096ccb5",
		"mcAppSKey": "3c1d2407297e4e5584d06caacdf53c5e",
		"mcNwkSKey": "02dbedc3349b3eeaa1d66f022530a7c2",
		"enableMQTT": false,
		"pushURL": "https://test.example.com/api/iotsquare",
		"headers": {
			"userID": "2333",
			"x-access-token": "6666"
		},
		"deviceSetup": 10,
		"deviceNums": 20,
		"updatetime": 1556617761768,
		"createtime": 1556617761768
	}
}
// 手动配置多播
{
	"code": 0,
	"msg": "ok",
	"data": {
		"mcEUI": "a0891ce817397ee8",
		"mcName": "mc_group_03",
		"region": "eu868",
		"subnet": "ch_00-07",
		"class": "C",
		"enableMCRemote": false,
		"groupID": 256,
		"mcAddr": "75bacecd",
		"mcAppSKey": "a32da0c03d3ab55e5be1dcc60f777481",
		"mcNwkSKey": "c013d964a16c9ee761cfd295614acf17",
		"deviceSetup": 10,
		"deviceNums": 10,
		"updatetime": 1556618089163,
		"createtime": 1556618082203
	}
}
```

## 7. 多播组节点接口

::: warning

1. `IoTSquare` 目前支持 `classC` 节点设备加入多播组

2. 同一多播组下的节点设备具有相同的 `region` `subnet`

3. 若多播组开启多播自动配置与拓展功能，节点需要从 `IoTSquare` 获取配置参数，若未开启，则使用预配置参数进行多播通信

:::

### 7.1 多播组节点列表

**URL：**`https://cloud.iotsquare.xyz/openapi/mcdevice/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，多播组唯一标识符|
|pageNo|int|分页页数|
|pageSize|int|分页大小|

::: warning

- `pageNo` 默认从 `1` 开始 `pageSize` 默认 `10`
- 当 `pageNo` 等于 `0` 且 `pageSize` 等于 `0` 时，将返回用户名下的所有网关（限制最多返回 `200` 条）

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|多播组的节点设备总数|
|data|[]MCDevice|数据体，包含多播组节点设备的数组|

**MCDevice：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string| `16` 位 `16` 进制字符串，节点设备唯一标识符|
|devName|string|节点名称|
|joined|bool|节点是否已同步多播组配置|
|createtime|int64|创建时间，单位为毫秒|

::: warning

- `joined` 表示是否已同步多播组配置
  - 若使用手动配置多播，默认 `true` 由用户确保密钥同步，默认设备已同步
  - 若使用自动配置多播，默认 `false` 当节点成功接收多播组配置且服务器收到设备响应后，置为 `true`

- `createtime` 表示设备添加到多播组中的时间

:::

**示例数据：**

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"amount": 50,
	"data": [{
		"devEUI": "476a2da3004b0039",
		"devName": "mc_node_00",
		"joined": true,
		"createtime": 1556324372803
	}, {
		"devEUI": "472b253300190039",
		"devName": "mc_node_01",
		"joined": true,
		"createtime": 1556324372848
	}, {
		"devEUI": "47ab2da30027002e",
		"devName": "mc_node_02",
		"joined": true,
		"createtime": 1556324372875
	}]
}
```

### 7.2 多播组节点创建

**URL：**`https://cloud.iotsquare.xyz/openapi/mcdevice/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，节点设备唯一标识符|
|devEUIs|[]string| `devEUI` 数组|

::: warning

- `IoTSquare` 支持批量添加多播组节点

- 若多播组启用了自动配置与拓展功能，添加节点后 `IoTSquare` 将根据节点上行历史，尝试下发多播组配置信息

- 若创建多播节点出错，会在 `data` 字段中包含每个异常 `devEUI` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
{
	"mcEUI":"a1cf5e687656d815",
	"devEUIs": ["b0cf5e634ec6d815", "55e1032590dc5682", "472b253300190039","476a2da3004b0039", "55e1032590dc5682"]
}
```

**请求响应：**

```json
// 绑定成功示例
{
	"code": 0,
	"msg": "ok"
}
// 绑定出错，部分节点绑定失败
{
    "code": 14008,
    "msg": "MCDevice Batch Bind Error",
    "data": [
        {
            "code": 4001,
            "msg": "MCGroup Not Exist",
            "devEUI": "55e1032590dc5682"
        },
        {
            "code": 14010,
            "msg": "MCDevice Already Bind Current Group",
            "devEUI": "472b253300190039"
        },
        {
            "code": 14011,
            "msg": "MCDevice Already Bind Other Group",
            "devEUI": "476a2da3004b0039"
        }
    ]
}
```

### 7.3 多播组节点删除

**URL：**`https://cloud.iotsquare.xyz/openapi/mcdevice/delete`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制字符串，节点设备唯一标识符|
|devEUIs|[]string| `devEUI` 数组|

::: warning

- `IoTSquare` 支持批量删除多播组节点
- 删除多播组节点时，同时解除节点与多播组绑定关系
- 若删除多播节点出错，会在 `data` 字段中包含每个异常 `devEUI` 对应的错误信息

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**

```json
{
	"mcEUI": "a1cf5e687656d815",
	"devEUIs": ["b0cf5e634ec6d815", "55e1032590dc5682", "0f475d71f5cd2f20", "84955e634ec6d815"]
}
```

**请求响应：**

```json
// 成功解绑示例
{
	"code": 0,
	"msg": "ok"
}
// 解绑出错，部分解绑失败
{
    "code": 14009,
    "msg": "MCDevice Batch Unbind Error",
    "data": [
        {
            "code": 14013,
            "msg": "MCDevice Not Exist",
            "devEUI": "476a2da3004b0039"
        },
        {
            "code": 14013,
            "msg": "MCDevice Not Exist",
            "devEUI": "55e1032590dc5682"
        }
    ]
}
```

## 8. 多播组下行接口

::: warning

1. `IoTSquare` 使用先入先出队列来存储多播组的应用层数据下行队列，每一个多播组对应一个下行队列

2. 由于多播组下行使用 `ClassB` 或 `ClassC` `LoRaWAN` 协议固定了数据速率，用户需要取节点对应频率区域的 `B` 类或 `C` 类参数来计算可下发的最大数据长度

3. 若用户开启多播拓展协议 `IoTSquare` 将接管下行调度，一个用户发送的多播组下行可能对应多个实际数据下发 `IoTSquare` 将确保尽可能多的组内节点接收到多播下行数据

4. 若用户未开启多播拓展协议 `IoTSquare` 将透传用户的多播组下行，不进行任务调度，用户需要在应用层自行实现多播组下行的确认回复

:::

### 8.1 多播组下行创建

**URL：**`https://cloud.iotsquare.xyz/openapi/mcdownlink/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|fPort|int|节点通信端口|
|data|string| `base64` 编码的数据字符串|

::: warning

- `fPort` 取值为 `1~199` `201~223` 其余端口为 `LoRaWAN` 协议预留端口

- `data` 为 `base64` 编码的数字字符串 `IoTSquare` 将对该数值解 `base64` 后以二进制格式组帧再下发至节点
  - 若原始数据为 `16` 进制数据，例如 `0x2333` 长度为两个字节 `base64` 编码后的数据为 `IzM=`
  - 若原始数据为 `ASCII` 字符串，例如 `2333` 长度为四个字节 `base64` 编码后的数据为 `MjMzMw==`

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|fCnt|int|本次数据下发对应的多播组下行帧计数器|

::: warning

- 每一个多播组都维护了一个下行帧计数器，调用数据下行接口返回的 `fCnt` 为本次数据下发对应的下行帧计数器编号

:::

**示例数据：**

**请求参数：**

```json
// 原始数据为 16 进制 0x2333 长度为两个字节
{
	"mcEUI": "b0cf5e634ec6d815",
	"fPort": 8,
	"data": "IzM="
}
// 原始数据为 ASCII 字符串 2333 长度为四个字节
{
	"mcEUI": "b0cf5e634ec6d815",
	"fPort": 8,
	"data": "MjMzMw=="
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok",
	"fCnt": 6666
}
```
## 9. 多播文件传输

### 9.1 创建文件传输

**URL：**`https://cloud.iotsquare.xyz/openapi/fuota/create`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|firmwareName|string| 文件传输任务名称 |
|redundancyPercent|float64|冗余率 百分比|
|payload|string| `base64` 编码的数据字符串|

::: warning

- `redundancyPercent` 取值范围为 `0.1-1`  

- `payload` 为 `base64` 编码的数字字符串 ,数据本体最大长度64kb,`IoTSquare` 将对该数值解 `base64` 后以二进制格式组帧再下发至节点
  - 若原始数据为 `16` 进制数据，例如 `0x2333` 长度为两个字节 `base64` 编码后的数据为 `IzM=`
  - 若原始数据为 `ASCII` 字符串，例如 `2333` 长度为四个字节 `base64` 编码后的数据为 `MjMzMw==`

:::

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求参数：**
```json
// 原始数据为 16 进制 0x2333 长度为两个字节
{
    "mcEUI":"cc3e92cea33ac62a",
    "firmwareName":"test",
    "payload":"IzM=",
    "redundancyPercent":0.3
}
// 原始数据为 ASCII 字符串 2333 长度为四个字节
{
    "mcEUI":"cc3e92cea33ac62a",
    "firmwareName":"test",
    "payload":"MjMzMw==",
    "redundancyPercent":0.3,
}
```

**请求响应：**

```json
{
	"code": 0,
	"msg": "ok"
}
```


### 9.2 文件传输任务列表

**URL：**`https://cloud.iotsquare.xyz/openapi/fuota/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|pageNo|int| 分页页数|
|pageSize|int| 分页大小|


**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|文件传输任务总数|
|data|[]FuotaDeploymentSummary|数据体,包含文件传输任务的数组|

**FuotaDeploymentSummary：**

|字段名|类型|描述|
|:---|:---|:---|
|fdID|int|文件ID|
|firmwareName|string|文件传输任务名称|
|payloadSize|int|文件大小|
|createtime|int|创建时间，单位为毫秒|
|updatetime|int|更新时间，单位为毫秒|
|state|string|状态：Created;SendFragSessSetup;EnqueueFragment;SendFragSessStatus;SendFragSessDel;Cleanup;Done;Unknown|
|nextStepTime|int|下一阶段任务启动时间,单位为毫秒|

**示例数据：**

**请求响应：**

```json
{
"code":0,
"msg":"ok",
"amount":2,
"data":[{"fdID":16,
"firmwareName":"test_2",
"payloadSize":13737,
"createtime":1608886853707,
"updatetime":1608886880433,
"state":"EnqueueFragment",
"nextStepTime":1608889984433},
{"fdID":14,
"firmwareName":"test_1",
"payloadSize":13737,
"createtime":1608877117472,
"updatetime":1608880297634,
"state":"Done",
"nextStepTime":-1}]
}
```

### 9.3 文件传输任务状态

**URL：**`https://cloud.iotsquare.xyz/openapi/fuota/status`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|fdID|int| 文件ID|


**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|data|FuotaDeploymentStatus|数据体,包含文件传输任务的数据|

**FuotaDeploymentStatus：**

|字段名|类型|描述|
|:---|:---|:---|
|fdID|int|文件数据ID|
|firmwareName|string|文件传输任务名称|
|payloadSize|int|文件大小|
|createtime|int|创建时间，单位为毫秒|
|updatetime|int|更新时间，单位为毫秒|
|state|string|状态：Created;SendFragSessSetup;EnqueueFragment;SendFragSessStatus;SendFragSessDel;Cleanup;Done;Unknown|
|nextStepTime|int|下一阶段任务启动时间,单位为毫秒|
|fragSize|int|分片大小|
|padding|int|填充字节数|
|redundancy|int|冗余分片数|
|descriptor|string|描述|
|nbFrag|int|分片数量|

**示例数据：**

**请求响应：**

```json
{"code":0,
"msg":"ok",
"data":{"fdID":16,
"firmwareName":"test_1",
"nbFrag":287,
"fragSize":48,
"padding":39,
"redundancy":86,
"payloadSize":13737,
"descriptor":"VXTy8g==",
"createtime":1608886853707,
"updatetime":1608886880433,
"state":"EnqueueFragment",
"nextStepTime":1608889984433}
}
```

### 9.4 文件传输任务设备列表

**URL：**`https://cloud.iotsquare.xyz/openapi/fuota/device/list`

**请求方式：**`GET`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|fdID|int| 文件ID|
|pageNo|int| 分页页数|
|pageSize|int| 分页大小|

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|
|amount|int|文件传输任务设备总数|
|data|[]FuotaDeploymentDevice|数据体,包含文件传输任务设备的数组|

**FuotaDeploymentDevice：**

|字段名|类型|描述|
|:---|:---|:---|
|devEUI|string|16 位 16 进制符串，节点设备唯一标识符|
|fdID|int|文件数据ID|
|nbFragReceived|string|设备接收分片总数|
|nbFragMissing|int|设备丢失分片总数|
|createtime|int|创建时间，单位为毫秒|
|updatetime|int|更新时间，单位为毫秒|
|state|string|状态：MC Not Joined;MC Joined;FragSessionSetupAns;FragSessStatusAns;FragSessDelAns;Done;Unknown|
|error_message|int|错误信息提示|

**示例数据：**

**请求响应：**

```json
{"code":0,
"msg":"ok",
"amount":1,
"data":[{"devEUI":"8cf9573000000067",
"fdID":16,
"nbFragReceived":0,
"nbFragMissing":0,
"createtime":1608886853721,
"updatetime":1608886853721,
"state":"MC Not Joined",
"error_message":""}]
}
```

### 9.5 终止文件传输升级任务

**URL：**`https://cloud.iotsquare.xyz/openapi/fuota/abort`

**请求方式：**`POST`

**请求参数：**

|字段名|类型|描述|
|:---|:---|:---|
|mcEUI|string| `16` 位 `16` 进制符串，多播组唯一标识符|
|fdID|int| 文件ID|

**响应参数：**

|字段名|类型|描述|
|:---|:---|:---|
|code|int|响应码|
|msg|string|响应消息|

**示例数据：**

**请求响应：**

```json
{
"code":0,
"msg":"ok"
}
```

## 10. 响应码

**系统：**

```
	0:    "ok",
	1001: "System Busy",

	1003: "No Token, Please log in again",
	1004: "Invalid Token, Please log in again",

	1006: "Empty Param",
	1007: "Param Error",
	1008: "Query Error",
	1009: "Network Busy",
	1010: "Permission Denied",

	1011: "Region Subnet Not Exist",
	1012: "Region Subnet Already Exist",

	1013: "Extend Proto Not Exist",
	1014: "Extend Proto Already Exist",
	1015: "Platform Conf Not Exist",
	1016: "Extend Proto Already Associate App",
	1017: "Region Subnet Not Support",
	1018: "Region Subnet Already Sync",
```

**用户：**

```
	2001: "Invalid Account",
	2002: "Account Not Exist",
	2003: "Account Already Exist",
	2004: "Account or Passwd Error",
```

**应用：**

```
	3001: "Application Not Exist",
	3002: "Application Already Exist",
	3003: "Application Batch Delete Error",
```

**节点：**

```
	4001: "Device Not Exist",
	4002: "Device Already Exist",
	4003: "Device Update Error",
	4004: "Device Duplicate DevAddr And NwkSKey",
	4005: "Device Count Exceeds Limit",
	4006: "Device Batch Delete Error",
```

**网关：**

```
	5001: "Gateway Not Exist",
	5002: "Gateway Already Exist",
	5003: "GatewayID Already Exist",
	5004: "GatewayName Already Exist",
	5005: "Gateway Count Exceeds Limit",
	5006: "Gateway Batch Delete Error",
```

**多播组：**

```

	14001: "MCGroup Not Exist",
	14002: "MCGroup Already Exist",
	14003: "MCGroup Duplicate DevAddr And NwkSKey",
	14004: "MCGroup Device Count Exceeds Limit",
	14005: "MCGroup Name Already Exist",
	14006: "MCGroup GenAppKey Error",
	14007: "MCGroup Batch Delete Error",
	14008: "MCDevice Batch Bind Error",
	14009: "MCDevice Batch Unbind Error",
	14010: "MCDevice Already Bind Current Group",
	14011: "MCDevice Already Bind Other Group",
	14012: "MCDevice Incompatible With Group",
	14013: "MCDevice Not Exist",
	14014: "MCGroup Not Enable MCRemote",
	14015: "MCGateway Batch Bind Error",
	14016: "MCGateway Batch Unbind Error",
	14017: "MCGateway Already Bind Current Group",
	14018: "MCGateway Incompatible With Group",
	14019: "MCGateway Not Exist",
	14020: "MCDownlink Already Exist",
	14021: "MCDownlink Not Exist",
	14022: "MCGroup Create Error",
	14023: "MCGroup invalid create",
```

**多播文件传输：**
```
16001: "Fuota Deployment Already Exist"
```
