---
title: Ladtp 组件使用手册
date: 2021-04-21 16:28:10
permalink: /02.manual/10.iotsquare/02.Ladtp/
---
# Ladtp 组件使用手册

::: warning

Ladtp 服务组件为 IoTSquare 平台子组件, 具有上行组包, 下行数据分包, 上行组包后分小包, 状态管理, 配置管理等功能, 若在创建应用时, 选择了 Ladtp 扩展协议, 则此应用下节点上行数据都会转发到 Ladtp 组件上进行处理.

:::

## 1. Ladtp 节点设置

用户需要参考`RHF3M485`使用手册, 使用串口工具连接 `PC`, 可以使用以下 `AT` 指令进行 `RHF3M485` 节点的相关设置.

### 1.1 设置频率

**输入:** `AT+DR`

**用来查询当前的频率计划，频率计划决定了当前的可用信道**

**返回：**

- `+DR: DR0`

- `+DR: CN470PREQUEL DR0 SF12 BW125K`

**表示当前的频率计划是：** `CN470PREQUEL`

**如果修改成：** `CN470`

**输入：**`AT+DR=CN470`

**成功后，对应的可用信道也修改了**

**返回：** `+DR: CN470`

::: warning

当修改频率计划的时候，可能返回`+DR: ERROR`是正常情况；

此时，只需要继续设置几遍直到返回正常！

:::

### 1.2 设置信道

**输入：**`AT+CH`

::: warning

用来查询当前的可用数据发送信道，节点的发送信道应该与网关的接收信道保持一致，否则节点发出去的数据，网关可能收不到。

:::

**返回：**

> **+CH: 8; 0,471500000,DR0,DR5; 1,471700000,DR0,DR5; 2,471900000,DR0,DR5; 3,472100000,DR0,DR5; 4,472300000,DR0,DR5; 5,472500000,DR0,DR5; 6,472700000,DR0,DR5; 7,472900000,DR0,DR5;**

::: warning

如果，第（1）步中的设置是 `AT+DR=CN470`，那么这里会出现从 `0` 号信道 `470.3MHz` 开始到 `95` 号信道 `489.3MHz` 结束，共 `96` 个可用信道，当要选择其中 `0-7` 信道的时候可以使用:

:::

**输入：** `AT+CH=NUM,0-7`

**成功后返回：** `+CH: NUM, 0-7`

### 1.3 设置串口

**输入：**`AT+UARTDFU`

::: warning

用来查询模块数据端的串口配置信息，与 `configure` 端串口不是同一个串口，数据段的串口停止位固定为 `1`，可以设置的只有波特率、校验位和数据位。

:::

**返回：**`+UARTDFU: 2400,1,8`

**表示，当前的通讯端口的波特率为 `2400bps`，奇校验位（`0：无校验位`，`1：奇校验`；`2：偶校验`），数据位 `8`**。

**如果，修改成，波特率 `9600`，偶校验位，数据位 `8`**

**输入：**`AT+UARTDFU=9600，2，8`

**返回：**`+UARTDFU: 9600,2,8`

::: warning

这里的配置，要与 `RHF3M485` 模块所外接的设备（如传感器等）的串口配置保持一致！

:::

### 1.4 选择串口

**输入：**`AT+COMMODE`

**查询当前设备与 `RHF3M485` 模块的连接方式，是 `RS485` 接口还是 `RS232` 接口**

**返回：**`+COMMODE: RS485`

**表示，当前模块与终端的连接方式为 `RS485`，那么 `RS232` 端口就不可用**

**如果，修改成** `RS232`

**输入：**`AT+COMMODE=RS232`

**返回：**`+COMMODE: RS232`

## 2. 网关设置

::: warning

这里对于网关的配置不详细叙述, 如果使用的是瑞兴恒方网络(深圳)有限公司的网关, 请查看对应网关型号的配置文档

确保 `RHF3M485` 发送信道是网关接收信道的子集, 同时网关正常链接到了服务器平台

::: details 列如

当前 `RHF3M485` 的可用发送信道是 `470.3~471.9`(`CN470` 的 `0-7` 信道), 那么网关的接收信道也应该是这 `8` 个或者多于这 `8` 个.

:::

## 3. Ladtp 服务组件

### 3.1 创建应用

用户创建 `ladtp` 应用, 需要在扩展协议下拉框选择 `ladtp` 协议, 推送接口可以填写 `http` 或 `https` 两种方式, 用户也可在 `Header` 字段中填写 `Token` 信息, 增加用户推送接口的安全性, 创建好 `ladtp` 应用后, 默认此应用下所有的节点为 `ladtp` 节点, 提示: 创建应用时, 请不要使能 `MQTT` 权限

---

![创建应用](创建应用.png)

---

### 3.2 创建设备

用户创建设备, 按要求填写 `DevEUI` `AppEUI` `AppKey` `频率区域` `设备类型` 来注册设备

---

![创建设备](创建设备.png)

---

### 3.3 功能列表

点击创建好的设备, 会跳转到设备详情页, 点击 `Ladtp` 组件下拉框, 可以看到如下 `Ladtp` 功能模块, 主要有 `Ladtp` 设备的状态管理, 配置管理, 下行窗口, 上行历史等.

---

![组件功能列表](组件功能列表.png)

---

### 3.4 状态管理

点击 `Ladtp` 状态管理, 可以看到此 `Ladtp` 设备的状态, 默认情况下, 服务器不会自动获取设备状态, 需要点击获取 `Ladtp` 设备最新状态按钮, 来使设备上报状态信息, 点击获取 `Ladtp` 设备最新状态按钮后, 隔 `5` 秒钟左右, 点击刷新按钮, 即可看到 `Ladtp` 设备最新状态.

---

![状态管理](状态管理.png)

---

### 3.5 配置管理

点击 `Ladtp` 配置管理按钮, 可以看到 `Ladtp` 设备默认配置, 主要有心跳包周期, 波特率, 校验方式, 数据位等.

---

![配置管理](配置管理.png)

---

点击修改配置按钮(按钮为下图中铅笔状图标), 可以更改配置, 由服务器将配置信息下发至节点, 隔 `5` 秒钟后, 刷新配置, 即可看到更改配置已生效.

---

![更改配置](更改配置.png)

---

### 3.6 下行窗口

点击 `Ladtp` 下行窗口按钮, 即可跳转到下行历史页面, 其中下发状态栏, 表示节点是否有收到此下行数据.

---

![下行历史](下行历史.png)

---

点击下行历史列表的任意一行数据, 即可弹出下行完整数据帧.

---

![下行数据](下行数据.png)

---

点击发送 `Ladtp` 下行按钮, 填入下行数据帧端口号, `HEX` 方式下行数据, 默认选择非确认帧下发, 即可下发下行数据.

---

![下发数据](下发数据.png)

---

### 3.7 上行历史

点击 `Ladtp` 上行历史按钮, 即可跳转到 `Ladtp` 设备上行历史消息列表.

---

![上行历史](上行历史.png)

---

同样, 点击上行历史列表里面的任意行数据, 即可弹出上行完整数据帧.

---

![上行数据](上行数据.png)

---

## 4. Ladtp 组件接口

此接口用于与用户 `CS` 服务器对接, 如果不需要做接口对接, 可以忽略此章节, 如果需要更进一步了解推送以及下发接口, 请参考
[IoTSquare API 文档](https://doc.iotsquare.xyz/docs/api/iotsquare/).

### 4.1 上行数据接口

::: tip
用户如果需要推送数据到 `CS` 服务器, 在 `IoTSquare` 创建应用时, 需要配置推送 `URL`.
:::

**URL：**`https://domain:port/openapi/ladtp/device/uplink`

**请求方式：**`POST`

**请求参数**

| 字段名称 | 类型   | 描述                                  |
| :------- | :----- | :------------------------------------ |
| devEUI   | string | 16 位 16 进制符串，节点设备唯一标识符 |
| data     | array  | 字节数组                              |

### 4.2 下行数据接口

::: tip

用户如果需要通过 `IoTSquare` 平台下行数据到 `Ladtp` 节点, 需要先使用用户名和密码, 登录到 `IoTSquare` 平台, 点击用户详情信息, 复制 `Api Token` 信息加入 `http` 下行请求头部字段, 如 `x-access-token = quakjadgxmb6ccodqvanp`, 调用此接口, 即可向 `IoTSquare` 平台下的 `Ladtp` 节点, 发送下行数据.

:::

**URL：**`https://cloud.iotsquare.xyz/openapi/ladtp/device/downlink`

**请求方式：**`POST`

**请求参数**

| 字段名称  | 类型   | 描述                                  |
| :-------- | :----- | :------------------------------------ |
| devEUI    | string | 16 位 16 进制符串，节点设备唯一标识符 |
| fPort     | int    | LoRa 数据帧端口号                     |
| data      | string | base64 编码的数据字符串               |
| confirmed | bool   | 是否为确认下行                        |

**响应参数**

| 字段名称 | 类型   | 描述     |
| :------- | :----- | :------- |
| code     | int    | 响应码   |
| msg      | string | 响应消息 |
