---
permalink: /02/01/01/06/
title: 接口和协议
date: 2021-08-06 14:01:13
---

## 前言

本文主要叙述RHF1S213 智能超声波水表的应用层协议。



## 数据帧结构说明

1. **多字节域以小端模式传输**

2. 数据帧基础结构为“CMD+ VAL0 + … + VALn”的形式

3. CMD：命令码

4. VALx：命令码携带的数据	

5. 所有的下行数据都需要设置 Fport为8，进行下发

   ![image-20210819160504925](https://wiki.risinghf.com/upload/img/bbad26c24938ce71468644b59461b749.png)

## 命令列表

| 命令码cmd | 传输方向  | 命令名称                  | VAL数据长度 | 描述                                                         |
| --------- | --------- | ------------------------- | ----------- | ------------------------------------------------------------ |
| 00        | 上行      | 压缩数据帧                | 1 - 242     | 周期上报该数据帧，数据帧包含上报周期、电量、冻结数据和累计流量 |
| 04        | 下行/上行 | 查询命令码                | 1 - 242     | 用于平台主动下发查询相关的参数和数据，使用方法04+cmd(需查询的数据的命令码) |
| 0D        | 上行      | ACK Error                 | 1           | 下发命令错误                                                 |
| 0E        | 上行      | ACK OK                    | 1           | 下发命令执行成功                                             |
| 0F        | 上行      | 警报数据帧                | 2           | 警报事件触发，如果检测到爆管或者逆流等情况，触发警报上行     |
| 71        | 上行/下行 | 累计流量上报/修改         | 8           | 上行时为上报累计流量，平台下发时为修改累计流量（慎用）       |
| 72        | 上行      | 瞬时流量上报              | 4           | 瞬时流量数据上报                                             |
| 73        | 上行      | 反向累计流量              | 8           | 反向累计流量数据上报                                         |
| 74        | 上行      | 前一天的冻结流量          | 8           | 前一天的冻结流量数据上报                                     |
| 8E        | 上行      | 设备表号上报              | 1           | 设备modbus地址、表号、设备版本信息数据上报                   |
| 95        | 上行      | 电池电量数据信息上报      | 1           | 电池电量数据信息上报                                         |
| 98        | 上行/下行 | 定时上报时间点/设置时间点 | 4           | 定时上报时间点日/时/分秒，各占一个字节，平台下发设置定时上报的时间点 |
| 9D        | 上行/下行 | 上报周期/设置上报周期     | 2           | 上报周期，设置上报周期                                       |
| 9F        | 上行      | 设备信息                  | 8           | 设备类型、生产时间和设备型号                                 |



## 上行数据类型解析（设备->平台）

###  00-压缩数据帧-周期上报数据帧

|                        | 命令码 | 上报周期  | 电量  | 保留      | 冻结数据            | 累计流量                                  |
| ---------------------- | ------ | --------- | ----- | --------- | ------------------- | ----------------------------------------- |
| 字节数（byte）         | 1      | 2         | 1     | 2         | 4                   | 8                                         |
| 取值范围(HEX,十六进制) | 00     | 001E-FFFF | 01-FE | 0000-FFFF | 0000 0000-FFFF FFFF | 0000 0000 0000 0000 - FFFF FFFF FFFF FFFF |

::: warning

1. 上报周期数据帧解析方法：

   - 当上报周期data小于或者等于28800

     上报周期=上报周期data 乘以 1秒

   - 当上报周期data大于28800时

   上报周期=28800秒+（上报周期data-28800)乘以5秒

   说明：data小于或者等于28800时，单位为1秒，data大于28800时，单位为5秒，
   
   例如：收到上报周期数据帧为0x8170 （小端模式，对应的十进制数据为28801）,则上报周期=28800乘以1秒+1乘以5秒=28805秒
   
2. 电量数据帧解析

   ![img](https://wiki.risinghf.com/upload/img/bb48ff82d327dcb79e74d9ef87b03f76.jpg)

   例如：0XFE 说明电量为100%

3. 冻结数据单位：0.1L

4. 累计流量：单位0.1L

::: 

### 04-查询命令码

|                        | 命令码 | 查询命令码 | 数据Valx                                            |
| ---------------------- | ------ | ---------- | --------------------------------------------------- |
| 字节数（byte）         | 1      | 1          | 1-20                                                |
| 取值范围(HEX,十六进制) | 04     | 00-FF      | 1-FFFF FFFF FFFF FFFF FFFF FFFF FFFF FFFF FFFF FFFF |

::: warning

1. 处理成功返回对应的命令码数据，处理失败返回ACK Error

2. 支持的查询功能码如下：

   0495//电池电量查询：

   0471//查询累计流量

   0472//查询瞬间流量

   0473//查询反向累计流量

   0474//查询冻结流量

   048E //水表modbus的地址

   0498  //定时上报时间

   049D //上报周期

   049F//上报初始化信息

:::

### 0D-ACK Error-下行命令错误

|                        | 命令码 | 执行命令码 |
| ---------------------- | ------ | ---------- |
| 字节数（byte）         | 1      | 1          |
| 取值范围(HEX,十六进制) | 0D     | 00-FF      |

::: warning

1. 下发命令错误

:::

### 0E-ACK OK-下行命令成功

|                        | 命令码 | 执行命令码 |
| ---------------------- | ------ | ---------- |
| 字节数（byte）         | 1      | 1          |
| 取值范围(HEX,十六进制) | 0E     | 00-FF      |

::: warning

1. 下发命令成功

:::

### 0F- 警报数据帧

|                        | 命令码 | 故障类型           |
| ---------------------- | ------ | ------------------ |
| 字节数（byte）         | 1      | 2                  |
| 取值范围(HEX,十六进制) | 0F     | 具体见故障类型定义 |

位映射模式：

|                 | Bit0     | Bit1     | Bit2           | Bit3             | Bit4-Bit7 | Bit8           | Bit10-Bit15 |
| --------------- | -------- | -------- | -------------- | ---------------- | --------- | -------------- | ----------- |
| 字节数（bit）   | 1        | 1        | 1              | 1                | 4         | 1              | 7           |
| 字节含义        | 爆管故障 | 漏水故障 | 传感器失效故障 | 安装位置反向故障 | 0         | 传感器声道异常 | 预留        |
| 取值范围（bit） | 0 or 1   | 0 or 1   | 0 or 1         | 0 or 1           | 0         | 0 or 1         | 0 or 1      |

序号模式：

|                        | 命令码 | 故障类型功能码  | 故障标志 |
| ---------------------- | ------ | --------------- | -------- |
| 字节数（byte）         | 1      | 1               | 1        |
| 取值范围(HEX,十六进制) | 0F     | 10 or 71 or  91 | 0 or 1   |

::: warning

1. 报警数据帧：水表出现异常状态时会发生自动警报或者可以通过QACK固定时间查询上报。故障类型定义: Bit 7 - 4  决定报警模式。  为0则模式为位映射模式 ， 否则为序号模式。(可以通过查询/QUERY 下行查询)

2. 序号模式警报有以下三种：

   0F  91 01  低电压    

   0F 10  01 温度故障  

   0F 71  01  流量过载

3. 位映射模式-多个警报同时发生时只会上报一次警报信号，如同时发生爆管和漏水故障时，将会上报：0x0F0300

4. 位映射模式警报和多个序号警报同时发生时，将上报多个警报信号，如同时发生传感器失效故障、低电压报警和流量过载时，将会上报：0x0F0400 0F9101 0F7101

5. 故障标识位为1 则说明故障发生，为0则说明故障没有发生

:::

### 71/73/74-累计/反向累计/前一天的冻结-流量上报

|                        | 命令码   | 累计流量/反向累计流量/前一天的冻结流量    |
| ---------------------- | -------- | ----------------------------------------- |
| 字节数（byte）         | 1        | 8                                         |
| 取值范围(HEX,十六进制) | 71/73/74 | 0000 0000 0000 0000 - FFFF FFFF FFFF FFFF |

::: warning

1.  单位 :mL/h
2. 71-累计流量 ，73-反向累计流量，74-前一天的冻结流量
3. 可以通过下发04-查询命令进行查询

:::

### 72-瞬间流量上报

|                        | 命令码 | 瞬间流量数据         |
| ---------------------- | ------ | -------------------- |
| 字节数（byte）         | 1      | 4                    |
| 取值范围(HEX,十六进制) | 72     | 0000 0000- FFFF FFFF |

::: warning

1.  单位 :mL/h
2. 可以通过下发04-查询命令进行查询

:::

### 8E-设备表号上报  

|                        | 命令码 | 表号   | 命令码 | 版本号           |
| ---------------------- | ------ | ------ | ------ | ---------------- |
| 字节数（byte）         | 1      | 1      | 1      | 3                |
| 取值范围(HEX,十六进制) | 8E     | 00- FF | 90     | 0000 00- FFFF FF |

::: warning

1.  版本号说明：

   Bit 23 - 21：LAP协议版本0 - 7

   Bit 20 - 18：硬件主版本号 0 - 7

   Bit 17 - 16：硬件次版本号 0 - 3

   Bit 15 - 12：软件主版本号 0 - 15

   Bit 11 - 8：软件次版本号 0 - 15

   Bit 7 - 0：软件补丁版本号 0 - 255

2. 可以通过下发04-查询命令进行查询

:::

### 95-电池电量数据信息上报  

|                        | 命令码 | 电量   |
| ---------------------- | ------ | ------ |
| 字节数（byte）         | 1      | 1      |
| 取值范围(HEX,十六进制) | 95     | 00- FF |

::: warning

1. 电量计算说明：

   01 -> 0% … FE -> 100%

![image-20210831110038973](https://wiki.risinghf.com/upload/img/a54800d4f11c9c2668fc13d226ab81a0.png)

2. 可以通过下发04-查询命令进行查询

:::

### 98-定时上报时间点

|                        | 命令码 | 日期         | 小时  | 分钟  | 秒    |
| ---------------------- | ------ | ------------ | ----- | ----- | ----- |
| 字节数（byte）         | 1      | 1            | 1     | 1     | 1     |
| 取值范围(HEX,十六进制) | 98     | 00- 1C or FF | 00-18 | 00-3C | 00-3C |

::: warning

1. 日期表示每个月某天，日期取值范围为1-28或者为FF ，当为FF时，表示每天都上报，
2. 可以通过下发04-查询命令进行查询

:::

### 9D-上报周期

|                        | 命令码 | 上报周期  |
| ---------------------- | ------ | --------- |
| 字节数（byte）         | 1      | 2         |
| 取值范围(HEX,十六进制) | 9D     | 001E-FFFF |

::: warning

1. 上报周期数据帧解析方法：

   - 当上报周期data小于或者等于28800

     上报周期=上报周期data 乘以 1秒

   - 当上报周期data大于28800时

   上报周期=28800秒+（上报周期data-28800)乘以5秒

   说明：data小于或者等于28800时，单位为1秒，data大于28800时，单位为5秒，
   
   例如：收到上报周期数据帧为0x8170 （小端模式，对应的十进制数据为28801）,则上报周期=28800乘以1秒+1乘以5秒=28805秒
   
2. 可以通过下发04-查询命令进行查询

:::

### 9F-设备信息  

|                        | 命令码 | 年份   | 周次  | 产品编号                   | 子编号 |
| ---------------------- | ------ | ------ | ----- | -------------------------- | ------ |
| 字节数（byte）         | 1      | 1      | 1     | 5                          | 1      |
| 取值范围(HEX,十六进制) | 9F     | 00- FF | 00-FF | 0000 0000 00- FFFF FFFF FF | 00- FF |

::: warning

1. 产品编号为字符串

:::

## 下行数据类型解析（平台<-设备）

### 00-压缩数据帧下发

|                        | 命令码 |
| ---------------------- | ------ |
| 字节数（byte）         | 1      |
| 取值范围(HEX,十六进制) | 00     |

::: warning

1. 如果该命令下发成功，水表将上报00压缩数据帧，否则将返回ACK Error 

:::

### 04-查询命令码

|                        | 命令码 | 需要查询的命令码 |
| ---------------------- | ------ | ---------------- |
| 字节数（byte）         | 1      | 1                |
| 取值范围(HEX,十六进制) | 04     | 00-FF            |

::: warning

1. 如果该命令下发成功，水表将上报对应命令的数据帧，否则将返回ACK Error

2. 支持的查询功能码如下：

   0495//电池电量查询：

   0471//查询累计流量

   0472//查询瞬间流量

   0473//查询反向累计流量

   0474//查询冻结流量

   048E //水表modbus的地址

   0498  //定时上报时间

   049D //上报周期

   049F//上报初始化信息

:::

### 71-修改累计流量

|                        | 命令码 | 累计流量                                  |
| ---------------------- | ------ | ----------------------------------------- |
| 字节数（byte）         | 1      | 8                                         |
| 取值范围(HEX,十六进制) | 71     | 0000 0000 0000 0000 - FFFF FFFF FFFF FFFF |

::: warning

1. 如果该命令下发成功，水表将上报累计流量，否则将返回ACK Error
2. 现场设备谨慎使用该功能

:::

### 9D-设置上报周期

|                        | 命令码 | 上报周期  |
| ---------------------- | ------ | --------- |
| 字节数（byte）         | 1      | 2         |
| 取值范围(HEX,十六进制) | 9D     | 001E-FFFF |

::: warning

1. 上报周期数据帧解析方法：

   - 当上报周期data小于或者等于28800

     上报周期=上报周期data 乘以 1秒

   - 当上报周期data大于28800时

   上报周期=28800秒+（上报周期data-28800)乘以5秒

   说明：data小于或者等于28800时，单位为1秒，data大于28800时，单位为5秒，
   
   例如：下发周期数据帧为0x8170 （小端模式，对应的十进制数据为28801）,则周期=28800乘以1秒+1乘以5秒=28805秒

:::

### 98-定时上报时间点

|                        | 命令码 | 日期         | 小时  | 分钟  | 秒    |
| ---------------------- | ------ | ------------ | ----- | ----- | ----- |
| 字节数（byte）         | 1      | 1            | 1     | 1     | 1     |
| 取值范围(HEX,十六进制) | 98     | 00- 1C or FF | 00-18 | 00-3C | 00-3C |

::: warning

1. 日期表示每个月某天，日期取值范围为1-28或者为FF ，当为FF时，表示每天都上报，
2. 例如：98ff130300 //设置每天13时03分00秒上报数据

:::

 

