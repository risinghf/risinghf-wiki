---
title: 服务器配置选择
date: 2021-10-08 09:00:00
permalink: /01/03/04/02/
---


## 服务器配置选择


| 建议使用服务器配置       | IoTSquare版本 | 最大上行TPS | 每个节点上行数据包平均间隔 | 可以承载的节点数 | 可以承载的网关数 | 上下行带宽总和预估(按应用层消息50字节) | 7天的历史消息数据磁盘存储使用量预估 | 
|-----------------|-------------|---------|---------------|----------|-------|-----------------------|--------------------|
| 2核4G,SSD 50GB   | 3.4.12      | 40      | 每15分钟         | 36000个   | 2000个 | 9.18 kB/s             | 20.57 GB           |
| 2核4G,SSD 50GB   |  3.4.12             | 40      | 每小时           | 144000个  | 2000个 | 9.18 kB/s             | 20.57 GB           | 
| 2核4G,SSD 50GB   |   3.4.12            | 40      | 每天            | 3456000个 | 2000个 | 9.18 kB/s             | 20.57 GB           | 
| 8核16G,SSD 100GB |    3.4.12           | 100     | 每15分钟         | 90000个   | 5000个 | 22.9 kB/s             | 51.43 GB           | 
| 8核16G,SSD 100GB      |    3.4.12           | 100     | 每小时           | 360000个  | 5000个 | 22.9 kB/s             | 51.43 GB           |
| 8核16G,SSD 100GB      |     3.4.12          | 100     | 每天            | 8640000个 | 5000个 | 22.9 kB/s             | 51.43 GB           |


### 跟据上行频率估算需要的服务器配置的方法
服务的承载能力和上行/下行并发能力有关，不能简单以网关数/节点数为判断依据（一个节点每5秒上行一个数据包，和1天上报一次，并发数上差了近2万倍),
而物联网的场景以上行为主，且服务处理下行的性能指标不比上行差，所以以上行来估算NS可以支撑多少节点。

#### 公式
`最大承载节点数 = 服务可承载的上行最大TPS x 发送上行间隔(秒为单位)`

服务可承载的上行最大TPS取决于服务器配置，对于4核8G的单机服务器，该值为90
发送上行间隔由应用层应用场景决定。

#### 示例
对于8核16G配置的服务器，服务可承载的上行最大TPS为100，如果节点每15分钟上行一包应用层数据包，发送上行间隔为900秒，则

`最大承载节点数 = 100 x 900 = 90000个`

对于8核16G配置的服务器，服务可承载的上行最大TPS为100，如果节点每小时上行一包应用层数据包，发送上行间隔为3600秒，则

`最大承载节点数 = 100 x 3600 = 360000个`

对于8核16G配置的服务器，服务可承载的上行最大TPS为100，如果节点每天上行一包应用层数据包，发送上行间隔为86400秒，则

`最大承载节点数 = 100 x 86400 = 8640000个`

上述数据可见，在物联网的低频场景下，在数据没有集中爆发的前提下，是可以支撑很大量的节点数的。

## 网关数对性能的影响
在上述TPS范围内，网关数量在压力测试中并不影响服务性能指标，但需要考虑网关上的程序与NS之间的MQTT连接维持TCP连接所带来的额外CPU负载以及一般TCP长连接服务本身的承载能力，
跟据经验判断，单进程的TCP长连接服务，不应该超过接收5000以上的并发连接。
所以可以承载的网关数量这一项属于经验估算。

## 流量预估
* MHDR和FHDR共13个字节，除了FRMPayload之外，假设每个应用层数据包有50个字节，LoraWAN数据包共63个字节，组包后`gw.UplinkFrame`约增加73个字节，共136字节，封装MQTT消息头增加2字节共138字节
* 假设一个主动上行都至少会触发一个MacCommand的下行，带了两个各为3节点的MacCommand，如果没有应用层数据下行，则FOpts不为空，LoraWAN数据包共18字节，然后组包`gw.DownlinkFrame`后会增加约55字节，共73字节，封装MQTT消息头增加2字节共75字节
* 网关回复NS`gw.DownlinkTxAck`数据包至少20个字节，封装MQTT消息头增加2字节共23字节

综上上，一个从网关转发设备的50字节应用层数据的上行LoraWAN数据包，及其后续触发的消息交互，会总共在网关与NS之间引入235字节的上行或下行流量。
如果上行每秒100包数据，则上行和下行的带宽加起来为22.9kB/s。

## 磁盘存储使用量预估
磁盘使用主要在LoraWAN的设备/网关/应用层三个维度的消息历史记录上

### 历史消息存储量预估
假设应用层消息平均50字节，
假设一个主动上行都至少会触发一个MacCommand的下行，
假设网络传输和数据库存储中没有任何形式的压缩。

* 数据包上行
  * 记录到网关历史消息中，上行消息LoraWAN封装增加13字节，封装`gw.UplinkFrameSet`增加85约字节，存到DB增加约54字节，共202字节
  * 记录到设备历史消息中，上行消息LoraWAN封装增加13字节，封装`gw.UplinkFrameSet`封装增加85约字节，存到数据库增加约141字节，共289字节
  * 记录到应用层上行历史中，存到数据库增加约90字节，共140字节
* 数据包下行: 带6个字节MacCommand的LoraWAN数据包共18字节
  * 记录到网关历史消息中，组包`gw.DownlinkFrame`后会增加约55字节，存到DB增加约58字节，共131字节
  * 记录到设备历史消息中，组包`gw.DownlinkFrame`后会增加约55字节，存到DB增加约96字节，共151字节

综上，一个从网关转发设备的50字节应用层数据的上行LoraWAN数据包，及其后续触发的消息交互，共产生约913字节的磁盘数据存储。
如果上行每秒40包50字节的应用层数据，且保存7天的历史消息数据，则共会产生20.57 GB的磁盘数据存储量。
同理如果上行每秒100包50字节的应用层数据，且保存7天的历史消息数据，则共会产生51.43 GB的磁盘数据存储量。
