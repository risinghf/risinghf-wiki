---
title: 3.4版本压力测试
date: 2021-10-08 09:00:00
permalink: /01/03/04/01/
---
## 服务运行环境
* 数据库服务器: (参考 https://help.aliyun.com/document_detail/276990.html )
    * A: 阿里云RDS基础版通用型`pg.n2.medium.1`
        * CPU 2核
        * 4GB内存
        * 硬盘: 20GB，类型ESSD P1，最大IOPS=2800
    * B: 阿里云RDS基础版通用型`pg.n2.large.1`
        * CPU 4核
        * 8G内存
        * 硬盘: 20GB，类型ESSD P1，最大IOPS=2800
    * C: 阿里云RDS基础版通用型`pg.n2.xlarge.1`
        * CPU 8核
        * 16G内存
        * 硬盘: 20GB，类型ESSD P1，最大IOPS=2800
* 网络:
    * 压测程序与IoTSquare/MQTT处于同一阿里云内网
    * MQTT与IoTSquare处于同一内网中
    * redis与IoTSquare处于同一内网中
    * 数据库与IoTSquare处于同一内网中
* 其余的服务进程置于独立的kubernetes容器中，其中IoTSquare服务进程最大可用的CPU 2核/1.5GB内存

## 可用性目标
### 上行	
至少99%的请求可以在1秒内完成一个事务: 数据包从MQTT客户端发送LoraWAN确认上行数据包到从MQTT接收到ACK标记的下行包

### 下行	
至少99%的请求可以在10秒内完成一个事务: 从发起HTTP请求到IoTSquare到网关接收相关数据包

## 上行压力测试
### 测试变量
* IoTSquare版本
* 上行TPS
* 数据库服务器类型
* 网关数/应用数
* 设备数

### 测试方法
* 模拟网关/设备，在IoTSquare上创建应用/设备/网关，并通过MQTT消息转发LoraWAN数据包，通过发送确认上行数据包发送到服务，并接收确认到ACK标记的数据包作为一个事务，统计每个事务的时间即延迟的分布情况
* 每一轮变量组合测试1小时，并记录相关的延迟分布指标和数据库服务器状态指标
* 找到上行TPS在满足可用性要求下的最大值

### 测试数据
| IoTSquare版本 | 目标TPS | 实际TPS | 网关数 | 应用数 | 设备数 | 设备上行间隔 | 数据库服务器 | 延迟0.25-0.5秒 | 延迟0.5-1秒 | 延迟1-2.5秒 | 延迟2.5-5秒 | 延迟5-10秒 | 数据库CPU使用率 | 数据库内存使用率 | 数据库每秒事务数 | 数据库IOPS |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |--- | --- |
| 3.4.9 | 40 | 40 | 1 | 1 | 500 | 12.5秒 | A | 无 | 99.53% | 0.44% | 无 | 无 | 56%-62% | 10.5%-13% | 750 | 60-66 |
| 3.4.9 | 45 | 45 | 1 | 1 | 450 | 10秒 | A | 无 | 95.4% | 4.45% | 无 | 无 | 65%-68% | 25%-25.4% | 824-834 | 64-90 |
| 3.4.9 | 50 | 50 | 1 | 1 | 500 | 10秒 | A | 无 | 76.87% | 23% | 无 | 无 | 70%-80% | 41%-44% | 861-1022 | 72-126 |
| 3.4.9 | 50 | 50 | 1 | 1 | 500 | 10秒 | B | 35.2% | 63.8% | 1.04% | 无 | 无 | 30%-32.8% | 3%-4% | 923-946 | 39-73 |
| 3.4.12 | 60 | 60 | 10 | 10 | 600 | 10秒 | B | 42.63% | 57.30% | 0.038% | 无 | 无 | 11.9%-12.5% | 4%-5% | 372-418 | 20-42 |
| 3.4.12 | 60 | 60 | 10 | 10 | 600 | 10秒 | C | 74.68% | 25.31% | 无 | 无 | 无 | 5.2%-6.4% | 3% | 398-405 | 26-49 |
| 3.4.12 | 70 | 70 | 10 | 10 | 700 | 10秒 | B | 35.10% | 64.82% | 0.076% | 无 | 无 | 12.7%-14.6% | 6%-8% | 443-469 | 26-64 |
| 3.4.12 | 70 | 70 | 10 | 10 | 700 | 10秒 | C | 37.11% | 62.83% | 0.062% | 无 | 无 | 5.5%-6.9% | 5% | 443-492 | 22-66 |
| 3.4.12 | 80 | 80 | 10 | 10 | 800 | 10秒 | B | 12.86% | 86.95% | 0.182% | 无 | 无 | 15%-17.4% | 9%-12% | 493-529 | 23-43 |
| 3.4.12 | 80 | 80 | 10 | 10 | 800 | 10秒 | C | 29.61% | 70.31% | 0.082% | 无 | 无 | 7.2%-7.9% | 6%-7% | 509-514 | 22-70 |
| 3.4.12 | 90 | 90 | 10 | 10 | 900 | 10秒 | B | 5.73% | 93.3% | 0.966% | 无 | 无 | 17.5%-19.2% | 14%-16% | 578-586 | 30-68 |
| 3.4.12 | 100 | 100 | 10 | 10 | 1000 | 10秒 | C | 8.85% | 90.23% | 0.92% | 无 | 无 | 9%-10.3% | 10% | 632-655 | 27-66 |
| 3.4.12 | 120 | 120 | 10 | 10 | 1200 | 10秒 | C | 1.3% | 83.33% | 14.82% | 0.24% | 0.30% | 10.5%-12.7% | 12%-13.4% | 679-813 | 34-85 |

## 下行压力测试
### 测试变量
* IoTSquare版本
* 上行TPS
* 数据库服务器类型
* 网关数/应用数
* 设备数

### 测试方法
* 以Class C模式进行下行测试
* 从调用服务下行接口`/api/device/downlink/create`到模拟的网关接收到这一包由MQTT下发的数据包作为一个事务，统计每个事务的时间即延迟的分布情况
* 每一轮变量组合测试1小时，并记录相关的延迟分布指标和数据库服务器状态指标
* 找到上行TPS在满足可用性要求下的最大值

### 测试数据

| IoTSquare版本 | 服务下行TPS | 单个网关接收TPS | 网关数 | 应用数 | 设备数 | 单个设备下行间隔 | 数据库服务器 | 是否在可用性范围内 | 10秒内完成占比 | 平均延迟 | 延迟0-0.25秒 | 延迟0.25-0.5秒 | 延迟0.5-1秒 | 延迟1-2.5秒 | 延迟2.5-5秒 | 延迟5-10秒 | 延迟10-15秒 | 延迟15-30秒 | 延迟30-50秒 | 延迟>50秒(也包含超时) | 数据库CPU使用率 | 数据库内存使用率 | 数据库每秒事务数 | 数据库IOPS | 
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |--- | --- | --- | --- | --- | --- | --- | --- |--- | --- |
| 3.4.13 | 70 | 0.1 | 700 | 700 | 700 | 10秒 | B | 否 | 99.218% | 3.687秒 | 0.014% | 0.024% | 0.053% | 0.377% | 98.44% | 0.31% | 0.28% | 0.02% | 0 | 0.49% | 13%-16.1% | 3%-4% | 545-755 | 70-108 | 
| 3.4.13 | 70 | 1 | 70 | 70 | 700 | 10秒 | B | 是 | 99.318% | 3.733秒 | 0.004% | 0.001% | 0.109% | 0.073% | 98.697% | 0.434% | 0.148% | 0.011% | 0.014% | 0.507% | 14%-15% | 4% | 542-592 | 73-100 | 
| 3.4.13 | 80 | 1 | 80 | 80 | 800 | 10秒 | B | 是 | 99.134% | 3.929秒 | 0.076% | 0.029% | 0.049% | 0.139% | 98.385% | 0.456% | 0.163% | 0.062% | 0.020% | 0.619% | 12.6%-15.4% | 2% | 531-619 | 71-91 | 
| 3.4.13 | 90 | 1 | 90 | 90 | 900 | 10秒 | B | 是 | 99.033% | 4.022秒 | 0.011% | 0.017% | 0.049% | 0.053% | 98.51% | 0.393% | 0.129% | 0.081% | 0.012% | 0.715% | 12.2%-15.6% | 3% | 499-623 | 57-105 | 
| 3.4.13 | 100 | 1 | 100 | 100 | 1000 | 10秒 | B | 否 | 98.923% | 4.142秒 | 0.033% | 0.043% | 0.058% | 0.055% | 98.357% | 0.376% | 0.158% | 0.1% | 0.009% | 0.809% | 12.9%-15.1% | 4% | 504-618 | 78-104 | 
| 3.4.13 | 100 | 2 | 50 | 50 | 1000 | 10秒 | B | 否 | 98.935% | 4.221秒 | 0.042% | 0.025% | 0.098% | 0.048% | 98.29% | 0.428% | 0.116% | 0.114% | 0.0143% | 0.82% | 13%-14% | 4%-5% | 548-585 | 74-89 | 
| 3.4.13 | 100 | 1 | 100 | 100 | 1000 | 10秒 | C | 是 | 99.036% | 3.653秒 | 0.018% | 0.025% | 0.071% | 0.08% | 98.486% | 0.357% | 0.105% | 0.08% | 0.008% | 0.769% | 5.8%-6.4% | 2% | 532-651 | 72-122 | 
| 3.4.13 | 110 | 1 | 110 | 110 | 1100 | 10秒 | C | 否 | 98.878% | 3.961秒 | 0.027% | 0.036% | 0.088% | 0.185% | 98.05% | 0.48% | 0.11% | 0.107% | 0.021% | 0.882% | 5.4%-6.7% | 2% | 513-627 | 64-85 | 
| 3.4.13 | 130 | 1 | 130 | 130 | 1300 | 10秒 | C | 否 | 98.522% | 4.129秒 | 0.006% | 0.03% | 0.016% | 0.004% | 98.149% | 0.315% | 0.16% | 0.138% | 0.036% | 1.143% | 5.8%-6.3% | 3% | 562-620 | 78-86 | 

## 总结
* 如果数据库服务器使用CPU 2核4G内存，要确保程序稳定可靠运行时上行平均每秒不能超过40个数据包，目前绝大多数客户场景都是选择这种配置
* 如果数据库服务器使用CPU 4核8G内存，要确保程序稳定可靠运行时上行或下行平均每秒不能超过90个数据包
* 如果数据库服务器使用CPU 8核16G内存，要确保程序稳定可靠运行时上行或下行平均每秒不能超过100个数据包
* 可行性目标对处理时间要求比较高，得到的最大上行TPS/下行TPS只是持续运行下保持服务器稳定的建议值，瞬时TPS超过最大值，影响也不大
* 内存和硬盘不是主要瓶颈，都有很大剩余量。主要的瓶颈在于CPU，所以服务器配置组合中应该优先保证CPU，如果是服务器使用的是公有云的共享型虚拟机，则建议选择同类别中CPU主频较高的选项

