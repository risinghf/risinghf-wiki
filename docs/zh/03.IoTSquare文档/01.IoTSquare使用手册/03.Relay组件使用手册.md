---
title: Relay组件使用手册
date: 2022-04-15 14:22:02
permalink: /03/01/03/
---
# Relay 组件使用手册

::: warning

中继服务组件为 `Iotsquare` 服务器的子组件，具有缓存模式 和重放模式，中继 的引入主要解决边缘设备连接问题。对于边缘设备，在信号条件不稳定情况下，难以进行可靠的通信， 由于边缘设备数量较少，考虑到成本因素，不适合再去布置新的网关。因此，通过添加一个中继主机，进行节点与网关间数据的转发。

:::

## 1.中继设置

参考 `[UM120095]` LoRaWAN 中继用户使用手册

## 2.网关设置

这⾥对于⽹关的配置不详细叙述, 如果使⽤的是瑞兴恒⽅⽹络(深圳)有限公司的⽹关, 请查看对应⽹关型号的配置⽂档;

::: warning

中继新增唤醒功能，需确认 `pktfwd` 协议是否支持，网关版本至少满足：
* bridge version: 0.0.8
* pktfwd version: 0.1.0 2021-02-01T04:24:02

:::

## 3.中继服务组件

### 3.1 创建应用

⽤⼾创建中继应⽤,需要在扩展协议下拉框选择选择 `relay` 协议, 推送接口可以填写 `http` 或 `https` 两种方式, 用户也可在 `Header` 字段中填写 `Token` 信息, 增加用户推送接口的安全性;

::: warning

创建应用时, 请不要使能 `MQTT` 权限

:::

![创建应用](https://wiki.risinghf.com/upload/img/af58a8652df1fe4f8a2f4cda03db69b2.png)

### 3.2 创建设备

⽤⼾创建设备, 按要求填写 `DevEUI` `AppEUI` `AppKey` 频率区域以及设备类型, 来注册设备

![创建设备](https://wiki.risinghf.com/upload/img/36544449ae1814a45859876c8a427e00.png)

### 3.3 功能列表

点击创建好的设备, 跳转到设备详情⻚, 点击中继组件下拉框, 可以看到如下中继组件功能模块, 主要有中继设备的状态管理, 配置管理,从机管理,下⾏窗口,历史状态等.

![功能列表](https://wiki.risinghf.com/upload/img/e383974d180b6f7a2e9267afffe81a65.png)

### 3.4 中继从机管理

中继从机管理是对中继的从机设备管理，含有从机状态列表，从机设备绑定，从机设备解绑等.

### 3.4.1 获取从机列表

点击更新从机列表后, 会使用主动唤醒方式下行数据,中继设备上报最新从机列表和中继设备状态，等待上报结果，正常约等于 `5s`

![从机列表](https://wiki.risinghf.com/upload/img/8da9541281baf9626d78e4fda8eb00f0.png)

### 3.4.2 绑定从机设备

点击绑定从机列表后，弹出未绑定的从机设备，可选择设备进行绑定，一次只能选择一个设备进行绑定，等待上报结果，正常约等于 `5s`

![绑定从机设备](https://wiki.risinghf.com/upload/img/c6afea83898e2be917eb48616f40c4ca.png)

### 3.4.3 解绑从机设备

点击解绑设备后，弹出确认解绑按钮，点击确认解绑，触发设备解绑，一次只能选择一个设备进行解绑定，等待上报结果，正常约等于 `5s`

 ![解绑从机设备](https://wiki.risinghf.com/upload/img/579946c78208147f90f137cf4f46427c.png)

### 3.5 中继配置管理

中继配置管理是对中继的配置参数管理，含有获取中继最新配置，修改中继配置参数，中继配置参数状态等.

![中继配置](https://wiki.risinghf.com/upload/img/9ce0267be95597049477b1971f5c043c.png)

### 3.5.1 获取中继最新配置

点击获取中继最新配置，弹出对话框确定，会主动下行，中继设备上报配置参数等信息. 等待上报结果，正常约等于 `5s`

![获取中继配置](https://wiki.risinghf.com/upload/img/88a40855ddc99dd13196d48e1aed2f3c.png)

### 3.5.2 修改中继配置

点击修改中继配置，修改中继配置参数，主动下行，等待修改结果，正常约等于 `5s`

 ![修改中继配置](https://wiki.risinghf.com/upload/img/c0b60af951f8574e7db624451ae4080d.png)

### 3.6 数据下行

数据下行窗口包含有中继下行窗口，使用唤醒模式下行或非唤醒模式下行；下行记录，其中下发状态栏, 表⽰节点是否有收到此下⾏数据

 ![下行历史](https://wiki.risinghf.com/upload/img/397b3002b6900baf4bab67b6e5145124.png)

### 3.6.1 下行窗口

点击中继下行窗口，即可跳转到下⾏窗口⻚⾯,  填⼊下⾏数据帧端口号, `hex` ⽅式下⾏数据, 默认选择⾮确认帧，非唤醒模式下发, 即可下发下⾏数据 ，选择唤醒模式下发，当设备睡眠模式时会被唤醒接收数据

![下行窗口](https://wiki.risinghf.com/upload/img/37dfc6cc75d783741d864bde72a9fd65.png)

### 3.6.2 下行记录

点击最近消息，默认显示当天数据；选择时间筛选，最大范围一周

### 3.7 中继历史消息

中继历史消息含有中继状态记录，中继事件记录（绑定，解绑，修改中继配置记录），默认显示近 `10` 条记录

![中继记录](https://wiki.risinghf.com/upload/img/e372ef8a3da1fb9f826bcf52600dd84e.png)


## 4. Relay 组件接口

此接口用于与用户 `CS` 服务器对接, 如果不需要做接口对接, 可以忽略此章节, 如果需要更进一步了解推送以及下发接口, 请参考
[IoTSquare API 文档](https://wiki.risinghf.com/zh/03/02/01/).

### 4.1 下行数据接口


::: tip

用户如果需要通过 `IoTSquare` 平台下行数据到 `Relay` 设备, 需要先使用用户名和密码, 登录到 `IoTSquare` 平台, 点击用户详情信息, 复制 `Api Token` 信息加入 `http` 下行请求头部字段, 如 `x-access-token = quakjadgxmb6ccodqvanp`, 调用此接口, 即可向 `IoTSquare` 平台下的 `Relay` 设备, 发送下行数据.

:::

**URL：** `https://domain:port/openapi/relay/device/downlink`

**请求方式：**`POST`

**请求参数**

| 字段名称  | 类型   |是否必填| 描述                                  |
| :-------- | :----- | :-----|:------------------------------- |
| devEUI    | string |是 |16 位 16 进制符串，节点设备唯一标识符 |
| fPort     | int    |是 |LoRa 数据帧端口号 可用范围 1~223                   |
| data      | string | 是|base64 编码的数据字符串               |
| confirmed | bool   | 否|是否为确认下行,默认为非确认下行 |
| wake      |bool| 否 | 是否使用中继唤醒模式下行,默认为非中继唤醒|

**响应参数**

| 字段名称 | 类型   | 描述     |
| :------- | :----- | :------- |
| code     | int    | 响应码   |
| msg      | string | 响应消息 |



### 4.2 上行数据接口

::: tip
用户如果需要推送数据到 `CS` 服务器, 在 `IoTSquare` 创建应用时, 需要配置推送 `URL`.
:::

**URL：** `https://domain:port/openapi/relay/device/uplink`

**请求方式：** `GET`

**请求参数**

| 字段名称 | 类型   | 是否必填|描述                                  |
| :------- | :----- | :---------|:------------------------------------ |
| devEUI   | string | 是 |16 位 16 进制符串，节点设备唯一标识符 |
|pageNo	| int |否 |分页页数，默认从1开始  |
|pageSize	| int |否 |分页大小，默认10  |
|startTime	| time |否 |起始时间 默认前24小时 |
|endTime	| time |否 |截至时间，默认当前时间  |

**响应参数**

| 字段名称 | 类型   | 描述     |
| :------- | :----- | :------- |
| code     | int    | 响应码   |
| msg      | string | 响应消息 |
| data      | object | 响应数据:参考返回示例 |


**返回示例**
```json
{
  "code": 0,
  "msg": "ok",
  "data": [
    {
      "devEUI": "8cf9573000000002",  //设备EUI 
      "battery": 100,  // 电池电量 
      "voltage": 3,  // 电压单位:v
      "slaveNum": 1,  // 从机数量
      "temperature": 21,   // 环境温度
      "rssi": -22,     // 接收信号强度
      "snr": 10.75,    // 信噪比
      "freq": 472.7,  // 上行频率
      "dr": 2,  // 上行速率
      "createtime": 1610533599678  // 上行心跳时间 ms
    },
    ....
  ],
  "amount": 78  // 上行总数 
}
```


### 4.3 中继设备状态

**URL：** `https://domain:port/openapi/relay/device/status`

**请求方式：** `GET`

**请求参数**

| 字段名称 | 类型   | 是否必填|描述                                  |
| :------- | :----- | :---------|:------------------------------------ |
| devEUI   | string | 是 |16 位 16 进制符串，节点设备唯一标识符 |

**响应参数**

| 字段名称 | 类型   | 描述     |
| :------- | :----- | :------- |
| code     | int    | 响应码   |
| msg      | string | 响应消息 |
| data      | object | 响应数据:参考返回示例 |


**返回示例**
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "devEUI": "8cf9573000000002", // 中继设备deveui
    "devAddr": "012ef4a9",   // 中继设备addr
    "devName": "rxhf-relay-test",  // 设备名字
    "class": "A",    // 设备类型
    "slaveNum": 2,  // 从机数量
    "productSn": "RHF3MR01-CN470ALID", // 产品SN
    "productTime": "yy20-wk25",  // 生产时间
    "firmwareVersion": "V1.0.1",  // 固件版本
    "firmwareSign": "e1107500",  // 固件签名
    "battery": 100,  // 电量
    "voltage": 3.07,  // 电压 ，单位：V
    "temperature": 30, // 温度
    "deviceWorkMode": 1,  // 设备工作模式：0非中继模式；1中继主机模式；2：中继从机模式
    "deviceBkdMode": 2,   // 后端模式: 0 缓存模式；1标准模式；2重放模式
    "lastSeen": 1663884378117,  // 最后通信时间戳，单位时间戳毫秒
    "lateState": true,        // 最后主动下行通信状态
    "lateTime": 1663833923813   //最后主动下行通信,例如：更新从机列表，获取中继配置
  }
}
```

