---
title: development manual
date: 2023-02-08 10:10:10
permalink: /01/02/05/02/
---

## 1 Introduction

RHF2S209 is independently developed and designed by Ruixing Hengfang Network (Shenzhen) Co., Ltd. It is an IoT LoRaWAN gateway that meets the requirements of the carrier. The gateway integrates LoRa, GPS, Ethernet, LTE, WiFi and backup lithium battery (optional). At the same time, the gateway allows users to carry out secondary development to facilitate the integration of third-party LoRa services for connecting to target servers.

## 2 hardware resources

- CPU: processor based on ARM Cortex-A7 core;
- Main frequency: 650MHz;

- Memory: 512Mbytes DDR3;

- Flash: 8Gbytes eMMC;

- Hardware watchdog;

- internal temperature sensor;

- GPS module;

- LoRaWAN module X1;

- RTC real time clock;

- WiFi/BT module;
- Ethernet;

- Built-in backup power supply (optional);

- NL688-CN 4G module (China, RHF2S209xxx-470):

LTE FDD: Band 1, Band 3, Band 5, Band 8, all bands with diversity 

LTE TDD: Band 34, Band 38, Band 39, Band 40, Band 41, all bands with diversity 

WCDMA: Band 1, Band 8, all bands with diversity 

TD-SCDMA: Band 34, Band 39 

GSM/GPRS/EDGE: 900 MHz/1800 MHz 

- NL688-EU 4G module (European region, RHF2S209xxx-868):

LTE FDD: Band 1, Band 3, Band 5, Band 7, Band 8, Band 20, all bands with diversity 

WCDMA: Band 1, Band 5, Band 8, all bands with diversity 

GSM/GPRS/EDGE: 850 MHz/900 MHz/1800 MHz

- NL668-AM 4G module (North America, RHF2S209xxx-915):

LTE FDD: Band 2, Band 4, Band 5, Band 12, Band 13, Band 17, Band 66, Band 71, all bands with diversity 

WCDMA: Band 2, Band 4, Band 5, all bands with diversity 

## 3 software resources

- Based on Linux kernel version 5.10.10;
- SPI driver;

- I2C driver;

- USB Host/Device driver;

- LoRaWAN module driver;

- 4G modem driver, support WCDMA/TD-LTE/GPRS/EDGE data transmission;

- GPS driver, support GPS precise timing;

- Ethernet driver;

- WiFi/BT driver;

- DMA driver;

- Button drive;

- LED driver;

- Power management driver;

- internal temperature sensor acquisition;

- Internal hardware watchdog

- RTC real-time clock management;

- Bootloader;

- Support image programming;

## 4 debug interface

RHF2S209 provides various debugging interfaces.

- web interface
- Serial debugging
- SSH login

This document mainly introduces serial port debugging and SSH login. The so-called debugging interface here is actually to open the command terminal of the device for debugging.

Regardless of whether you use the serial port or SSH to log in to the device, the default username and password are as follows:

User: root

Password: risinghf

### 4.1 Serial debugging

Before connecting your device to your computer, please install the FTDT USB to UART driver. Open the cover of the device, use a USB-to-serial tool to connect the J4 pin of the device to the USB port of the computer, and then you will find a COM port on your computer. Select "Serial" on ExtraPutty and fill in the correct COM port number and baud rate 115200, then you can successfully connect to the device.

![image-20230216184550055](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/9f07832acf3a9318caa97060a4fd69d5.png)

Then enter the user "root" and password "risinghf" to log in to the device.

![image-20230216184624937](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/9c6d9b693e790da58aa560bae29ce5d8.png)

### 4.2 SSH login

#### 4.2.1 Login using LAN DHCP IP

Connect the device to the LAN through a network cable, and use the DHCP service of the upper-level router to query the IP address of the device in the LAN. After obtaining the IP address of the device, use the Putty tool to log in to the command terminal.

![image-20230216185227760](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/0f68889ea38831c99268da6a50140eb9.png)

#### 4.2.2 Login using WiFi IP

Scan the WiFi signal on the computer, find the device whose SSID is RHF2S209_XXXXXX and connect it. After the computer is connected to the device, the default IP is 192.168.8.1. After obtaining the IP address of the device, use the Putty tool to log in to the command terminal. WiFi default SSID and password:

SSID: RHF2S209_XXXXXX

Password: RisingHF_XXXXXX

Note: "XXXXXX" ends with the last 3 bytes of the MAC address of the device, and if there are letters, use uppercase letters.

![image-20230216185103177](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/fbee7ae126865e43e506a0205f2c455c.png)

## 5 Build development environment

RHF2S209 currently integrates loraserver, IoTSquare and the LoRa service program independently developed by the company and compatible with the standard packet_forwarder. Users can choose to start one of the LoRa service programs to connect to the corresponding server, or develop a new LoRa service program and integrate it into the gateway to connect to third parties. target server. The gateway provides a cross-compilation method to help users build their own binary files for device operation.

**This tutorial builds a cross-compilation environment based on the Ubuntu 20.04.5 LTS 64-bit operating system**

### 5.1 Download the cross-compilation toolchain

Open the toolchain download page https://www.st.com/en/embedded-software/stm32mp1dev.html#get-software, select `Yocto_SDK` 3.0.0 version to download.

![image-20230216101637939](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/1129b0a3d243dc45ce7c14f4adf5b02f.png)

### 5.2 Unzip and install the cross-compilation toolchain

After downloading, you will get a `en.SDK-x86_64-stm32mp1-openstlinux-5.10-dunfell-mp1-21-03-31.tar.xz` file. Unzip it and install it.

```
PC $> tar xvf en.SDK-x86_64-stm32mp1-openstlinux-5.10-dunfell-mp1-21-03-31.tar.xz
PC $> chmod +x st-image-weston-openstlinux-weston-stm32mp1-x86_64-toolchain-3.1-openstlinux-5.10-dunfell-mp1-21-03-31.sh/st-image-weston-openstlinux-weston-stm32mp1-x86_64-toolchain-3.1-openstlinux-5.10-dunfell-mp1-21-03-31.sh
PC $> ./st-image-weston-openstlinux-weston-stm32mp1-x86_64-toolchain-3.1-openstlinux-5.10-dunfell-mp1-21-03-31.sh/st-image-weston-openstlinux-weston-stm32mp1-x86_64-toolchain-3.1-openstlinux-5.10-dunfell-mp1-21-03-31.sh
```

### 5.3 Enter the cross-compilation environment

When the execution is successful, enter the cross-compilation environment.

```
PC $> . /opt/st/stm32mp1/3.1-openstlinux-5.10-dunfell-mp1-21-03-31/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi
```

When entering the cross-compilation environment, the environment variables include the ARCH and CROSS_COMPILE variables by default.

### 5.4 Test the cross-compilation environment

Test whether gcc was successful. Enter `arm-linux-gnueabihf-gcc -v` in the command terminal, if the following content is output, the installation is successful.

```
PC $> arm-linux-gnueabihf-gcc -v
Using built-in specs.
COLLECT_GCC=arm-linux-gnueabihf-gcc
COLLECT_LTO_WRAPPER=/opt/gcc-arm-8.2-2018.08-x86_64-arm-linux-gnueabihf/bin/../libexec/gcc/arm-linux-gnueabihf/8.2.1/lto-wrapper
Target: arm-linux-gnueabihf
Configured with: /tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/src/gcc/configure --target=arm-linux-gnueabihf --prefix= --with-sysroot=/arm-linux-gnueabihf/libc --with-build-sysroot=/tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/build-arm-linux-gnueabihf/install//arm-linux-gnueabihf/libc --enable-gnu-indirect-function --enable-shared --disable-libssp --disable-libmudflap --disable-libsanitizer --enable-checking=release --enable-languages=c,c++,fortran --with-gmp=/tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/build-arm-linux-gnueabihf/host-tools --with-mpfr=/tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/build-arm-linux-gnueabihf/host-tools --with-mpc=/tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/build-arm-linux-gnueabihf/host-tools --with-isl=/tmp/dgboter/bbs/bc-b1-2-11--rhe6x86_64/buildbot/rhe6x86_64--arm-linux-gnueabihf/build/build-arm-linux-gnueabihf/host-tools --with-arch=armv7-a --with-fpu=neon --with-float=hard --with-arch=armv7-a --with-pkgversion='GNU Toolchain for the A-profile Architecture 8.2-2018-08 (arm-rel-8.23)'
Thread model: posix
gcc version 8.2.1 20180802 (GNU Toolchain for the A-profile Architecture 8.2-2018-08 (arm-rel-8.23))
```

### 5.5 cross compile

Compile and run hello world.

Add a test.c file

```
PC $> vi test.c
#include <stdio.h>

int main(int argc, char *argv[])
{
	printf("hello world!\n");
	return 0;
}
```

Add Makefile

```
PC $> vi Makefile
PROG = test
SRCS = test.c

CLEANFILES = $(PROG)

# Add / change option in CFLAGS and LDFLAGS
CFLAGS += -Wall
LDFLAGS += 

all: $(PROG)

$(PROG): $(SRCS)
	$(CC) -o $@ $^ $(CFLAGS) $(LDFLAGS)

clean:
	rm -f $(CLEANFILES) $(patsubst %.c,%.o, $(SRCS))
```

**`$CC` is a variable of the cross-compilation toolchain. It is recommended to use `$CC` to compile instead of `arm-linux-gnueabihf-gcc`, otherwise problems such as not finding dependent libraries may occur.**

**Because there is already a `CFLAGS` environment variable in the environment variable, the Makefile uses `CFLAGS +=` to append its own selection. The same is true for `LDFLAGS`. **

Cross compile test.c

```
PC $> make
```

Upload to the device to run

```
DEV $> ./test 
hello world!
```

## 6 Compile sx1302_hal/packet forwarder

The sx1302 driver library includes both sx1302_hal and packet forwarder, so just compile sx1302_hal.

### 6.1 download

Download the sx1302 driver library.

```
PC $> git clone https://github.com/Lora-net/sx1302_hal.git
```

### 6.2 patch

Modify to compile the sx1302 driver library in cross-compilation mode, the following is the modified patch.

```
diff --git a/Makefile b/Makefile
index 687c12c..6e469e8 100644
--- a/Makefile
+++ b/Makefile
@@ -11,44 +11,44 @@ export
 all: libtools libloragw packet_forwarder util_net_downlink util_chip_id util_boot util_spectral_scan
 
 libtools:
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 libloragw: libtools
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 packet_forwarder: libloragw
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 util_net_downlink: libtools
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 util_chip_id: libloragw
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 util_boot: libloragw
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 util_spectral_scan: libloragw
-       $(MAKE) all -e -C $@
+       $(MAKE) all -C $@
 
 clean:
-       $(MAKE) clean -e -C libtools
-       $(MAKE) clean -e -C libloragw
-       $(MAKE) clean -e -C packet_forwarder
-       $(MAKE) clean -e -C util_net_downlink
-       $(MAKE) clean -e -C util_chip_id
-       $(MAKE) clean -e -C util_boot
-       $(MAKE) clean -e -C util_spectral_scan
+       $(MAKE) clean -C libtools
+       $(MAKE) clean -C libloragw
+       $(MAKE) clean -C packet_forwarder
+       $(MAKE) clean -C util_net_downlink
+       $(MAKE) clean -C util_chip_id
+       $(MAKE) clean -C util_boot
+       $(MAKE) clean -C util_spectral_scan
 
 install:
-       $(MAKE) install -e -C libloragw
-       $(MAKE) install -e -C packet_forwarder
-       $(MAKE) install -e -C util_net_downlink
-       $(MAKE) install -e -C util_chip_id
-       $(MAKE) install -e -C util_boot
-       $(MAKE) install -e -C util_spectral_scan
+       $(MAKE) install -C libloragw
+       $(MAKE) install -C packet_forwarder
+       $(MAKE) install -C util_net_downlink
+       $(MAKE) install -C util_chip_id
+       $(MAKE) install -C util_boot
+       $(MAKE) install -C util_spectral_scan
 
 install_conf:
-       $(MAKE) install_conf -e -C packet_forwarder
+       $(MAKE) install_conf -C packet_forwarder
 
 ### EOF
diff --git a/libloragw/Makefile b/libloragw/Makefile
index 881442f..fa0dfb3 100644
--- a/libloragw/Makefile
+++ b/libloragw/Makefile
@@ -8,10 +8,10 @@ include ../target.cfg
 
 ARCH ?=
 CROSS_COMPILE ?=
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
-CFLAGS := -O2 -Wall -Wextra -std=c99 -Iinc -I. -I../libtools/inc
+CFLAGS += -O2 -Wall -Wextra -std=c99 -Iinc -I. -I../libtools/inc
 
 OBJDIR = obj
 INCLUDES = $(wildcard inc/*.h) $(wildcard ../libtools/inc/*.h)
diff --git a/libtools/Makefile b/libtools/Makefile
index cf84988..321e0fd 100644
--- a/libtools/Makefile
+++ b/libtools/Makefile
@@ -4,10 +4,10 @@
 
 ARCH ?=
 CROSS_COMPILE ?=
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
-CFLAGS := -O2 -Wall -Wextra -std=c99 -Iinc -I.
+CFLAGS += -O2 -Wall -Wextra -std=c99 -Iinc -I.
 
 OBJDIR = obj
 INCLUDES = $(wildcard inc/*.h)
diff --git a/packet_forwarder/Makefile b/packet_forwarder/Makefile
index 2325a47..a244c58 100644
--- a/packet_forwarder/Makefile
+++ b/packet_forwarder/Makefile
@@ -24,10 +24,10 @@ RELEASE_VERSION := `cat ../VERSION`
 
 ### Constant symbols
 
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
-CFLAGS := -O2 -Wall -Wextra -std=c99 -Iinc -I. -I../libtools/inc
+CFLAGS += -O2 -Wall -Wextra -std=c99 -Iinc -I. -I../libtools/inc
 VFLAG := -D VERSION_STRING="\"$(RELEASE_VERSION)\""
 
 ### Constants for Lora concentrator HAL library
diff --git a/tools/payload_tools/Makefile b/tools/payload_tools/Makefile
index ed5e5fe..0ae0469 100644
--- a/tools/payload_tools/Makefile
+++ b/tools/payload_tools/Makefile
@@ -6,10 +6,10 @@ include ../../target.cfg
 
 ARCH ?=
 CROSS_COMPILE ?=
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
-CFLAGS := -O2 -Wall -Wextra -std=c99 -I. -I../../libtools/inc
+CFLAGS += -O2 -Wall -Wextra -std=c99 -I. -I../../libtools/inc
 
 ### linking options
 
diff --git a/util_boot/Makefile b/util_boot/Makefile
index 399db85..1d3d50d 100644
--- a/util_boot/Makefile
+++ b/util_boot/Makefile
@@ -16,19 +16,19 @@ ifeq '$(BUILD_MODE)' 'alpha'
   WARN_CFLAGS   :=
   OPT_CFLAGS    := -O0
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq '$(BUILD_MODE)' 'debug'
   $(warning /\/\/\/  Building in 'debug' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq  '$(BUILD_MODE)' 'release'
   $(warning /\/\/\/  Building in 'release' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2 -ffunction-sections -fdata-sections
   DEBUG_CFLAGS  :=
-  LDFLAGS       := -Wl,--gc-sections
+  LDFLAGS       += -Wl,--gc-sections
 else
   $(error BUILD_MODE must be set to either 'alpha', 'debug' or 'release')
 endif
@@ -41,9 +41,9 @@ APP_LIBS := -lloragw -lm -ltinymt32 -lrt
 LIB_PATH := ../libloragw
 
 ### Expand build options
-CFLAGS := -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CFLAGS += -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
 ### General build targets
 all: $(APP_NAME)
diff --git a/util_chip_id/Makefile b/util_chip_id/Makefile
index 50b110c..5bbe5cf 100644
--- a/util_chip_id/Makefile
+++ b/util_chip_id/Makefile
@@ -16,19 +16,19 @@ ifeq '$(BUILD_MODE)' 'alpha'
   WARN_CFLAGS   :=
   OPT_CFLAGS    := -O0
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq '$(BUILD_MODE)' 'debug'
   $(warning /\/\/\/  Building in 'debug' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq  '$(BUILD_MODE)' 'release'
   $(warning /\/\/\/  Building in 'release' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2 -ffunction-sections -fdata-sections
   DEBUG_CFLAGS  :=
-  LDFLAGS       := -Wl,--gc-sections
+  LDFLAGS       += -Wl,--gc-sections
 else
   $(error BUILD_MODE must be set to either 'alpha', 'debug' or 'release')
 endif
@@ -41,9 +41,9 @@ APP_LIBS := -lloragw -lm -ltinymt32 -lrt
 LIB_PATH := ../libloragw
 
 ### Expand build options
-CFLAGS := -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CFLAGS += -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
 ### General build targets
 all: $(APP_NAME)
diff --git a/util_net_downlink/Makefile b/util_net_downlink/Makefile
index 01829d2..cfb8fba 100644
--- a/util_net_downlink/Makefile
+++ b/util_net_downlink/Makefile
@@ -16,19 +16,19 @@ ifeq '$(BUILD_MODE)' 'alpha'
   WARN_CFLAGS   :=
   OPT_CFLAGS    := -O0
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq '$(BUILD_MODE)' 'debug'
   $(warning /\/\/\/  Building in 'debug' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq  '$(BUILD_MODE)' 'release'
   $(warning /\/\/\/  Building in 'release' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2 -ffunction-sections -fdata-sections
   DEBUG_CFLAGS  :=
-  LDFLAGS       := -Wl,--gc-sections
+  LDFLAGS       += -Wl,--gc-sections
 else
   $(error BUILD_MODE must be set to either 'alpha', 'debug' or 'release')
 endif
@@ -41,9 +41,9 @@ APP_LIBS := -lparson -lbase64 -lpthread
 LIB_PATH := ../libtools
 
 ### Expand build options
-CFLAGS := -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CFLAGS += -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
 ### General build targets
 all: $(APP_NAME)
diff --git a/util_spectral_scan/Makefile b/util_spectral_scan/Makefile
index 9322009..381c7e5 100644
--- a/util_spectral_scan/Makefile
+++ b/util_spectral_scan/Makefile
@@ -16,19 +16,19 @@ ifeq '$(BUILD_MODE)' 'alpha'
   WARN_CFLAGS   :=
   OPT_CFLAGS    := -O0
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq '$(BUILD_MODE)' 'debug'
   $(warning /\/\/\/  Building in 'debug' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2
   DEBUG_CFLAGS  := -g
-  LDFLAGS       :=
+  LDFLAGS       +=
 else ifeq  '$(BUILD_MODE)' 'release'
   $(warning /\/\/\/  Building in 'release' mode \/\/\/\)
   WARN_CFLAGS   := -Wall -Wextra
   OPT_CFLAGS    := -O2 -ffunction-sections -fdata-sections
   DEBUG_CFLAGS  :=
-  LDFLAGS       := -Wl,--gc-sections
+  LDFLAGS       += -Wl,--gc-sections
 else
   $(error BUILD_MODE must be set to either 'alpha', 'debug' or 'release')
 endif
@@ -41,9 +41,9 @@ APP_LIBS := -lloragw -lm -ltinymt32 -lrt
 LIB_PATH := ../libloragw
 
 ### Expand build options
-CFLAGS := -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
-CC := $(CROSS_COMPILE)gcc
-AR := $(CROSS_COMPILE)ar
+CFLAGS += -std=c99 $(WARN_CFLAGS) $(OPT_CFLAGS) $(DEBUG_CFLAGS)
+CC ?= $(CROSS_COMPILE)gcc
+AR ?= $(CROSS_COMPILE)ar
 
 ### General build targets
 all: $(APP_NAME)
```

### 6.3 compile

```
PC $> make
```

After the compilation is successful, the user will get several binary files, among which the packet_forwarder/lora_pkt_fwd file is more important, it is the LoRa service program connected to the server.

## 7 How to integrate third-party LoRa services

This document uses foo-pktfwd as an example to show how to integrate third-party LoRa services in the device. Assume that the user has successfully cross-compiled lora_pkt_fwd.

### 7.1 Disable built-in LoRa service

The device itself also has a built-in LoRa service, but it will not be started by default. If the user starts the LoRa service, please close it first.

```
lora_service -s
```

### 7.2 Install the LoRa service program

1. The gateway has a directory specification when installing the LoRa service program. It is recommended that users create their own directories under the /opt directory. like:

```
mkdir -p /opt/foo-pktfwd
```

2. Upload lora_pkt_fwd, global_conf.json and local_conf.json to the `/opt/foo-pktfwd` directory, if there are more frequency plan configuration files, put them in the `/opt/foo-pktfwd/cfg` directory. For more information about the directory structure, please refer to `/opt/pktfwd`.

3. Use systemd's self-starting service to start the process by adding the foo-pktfwd.service file in the /lib/systemd/system directory. **Note: If the user configures the following service, please remove `#` and the following comment, otherwise it may not work properly. **

```
[Unit]
Description=Foo LoRa packet forwarder # The server description information
After=initonce.service
After=network.target # Start this service after network service

[Service]
Restart=always # The action of restarting after the process exits
RestartSec=60 # With Restart, the process restarts after exiting for 60 seconds
WorkingDirectory=/opt/foo-pktfwd # working directory of the process
ExecStartPre=/usr/local/sbin/web_select_lora_freq --name foo-pktfwd # Set the web interface state before starting the final process
ExecStartPre=/usr/local/lora/lora_service -c /usr/local/lora/.lora_service.json -ffoo-pktfwd # Mutually exclude other LoRa service processes before starting the final process
ExecStartPre=/usr/local/sbin/gwrst # Execute the process before starting the final process
ExecStartPre=/usr/local/sbin/gwrst1 # Execute the process before starting the final process
ExecStart=/opt/foo-pktfwd/lora_pkt_fwd # The process that was finally launched

[Install]
WantedBy=multi-user.target 
```

The above briefly introduces how to start a LoRa service process. The user can see in foo-pktfwd.service, the reason why to start the final process is to execute `/usr/local/lora/lora_service -c /usr/local/lora/.lora_service.json -ffoo-pktfwd`command, It is because this command acts as a mutual exclusion of other processes. The -f parameter means that except for the foo-pktfwd process, all other processes (other processes here are processes registered to lora_service) are stopped.

### 7.3 Register LoRa service mutual exclusion

```
lora_service -a '{"foo-pktfwd":["foo-pktfwd.service"]}'
```

After registering LoRa service mutual exclusion, your process will be mutually exclusive with other LoRa service processes, and only one LoRa service can be started at a time to prevent LoRa module conflicts.

### 7.4 Register web interface menu

Register a web interface LoRa service menu, so that users can start or close the LoRa service in the web interface.

```
web_add_lora_service --name "foo-pktfwd" \
    --menu "foo-pktfwd" --index "99" \
    --wdir "/opt/foo-pktfwd" \
    --dir "/opt/foo-pktfwd/cfg" \
    --cfgs "/opt/foo-pktfwd/global_conf.json /opt/foo-pktfwd/local_conf.json"
```

--name: web interface name, unique identifier.

--menu: web interface menu title.

--index: web interface order.

--wdir: Working directory.

--dif: Optional frequency configuration file directory.

--cfgs: use frequency configuration file, can be empty.

### 7.5 System self-start

When all the work is done, execute the following command to start the `foo-pktfwd` LoRa service on boot.

```
lora_service -r foo-pktfwd
```

## 8 software interface

### 8.1 Obtain basic gateway information

The gateway provides some commands to obtain the basic information of the device, which is convenient for users to integrate.

- Get the gateway model

```
$> get_model
RHF2S209BH8-470
```

- Get firmware version

```
$> get_fw_ver 
1.0.0
```

- Get build date of firmware

```
$> get_fw_date 
2023-01-03
```

- Get hardware version

```
$> get_hw_ver 
1.0
```

- Get the number of LoRa channels, currently 8 channels

```
$> get_lora_channel_num 
8
```

- Get whether the gateway supports full duplex, `yes` means it supports full duplex, `no` means it only supports half duplex

```
$> get_lora_full 
no
```

- Get the battery capacity, `no` means that the battery is not supported

```
$> get_battery 
9.6V/3200mAh
```

- Get the linux kernel version

```
$> uname -r
5.10.10
```

- Get the current running time of the system

```
$> cat /proc/uptime
687.67 584.27
```

The first character represents the current running time of the gateway, unit: second. As shown above: the representative gateway has been running continuously for 687.67 seconds.

- Get the current system time and time zone

```
$> timedatectl show
Timezone=Universal
LocalRTC=no
CanNTP=yes
NTP=yes
NTPSynchronized=yes
TimeUSec=Fri 2023-02-17 02:08:02 UTC
RTCTimeUSec=Fri 2023-02-17 02:08:03 UTC
```

Timezone: The time zone used, the default `Universal`.

TimeUSec: the current time of the system.

RTCTimeUSec: RTC module time.

- Get Ethernet MAC address

```
$> cat /sys/class/net/eth0/address 
8c:f9:57:60:15:dc
```

- Get ethernet ip

```
$> ifconfig eth0
eth0      Link encap:Ethernet  HWaddr 8C:F9:57:60:15:DC  
          inet addr:192.168.0.83  Bcast:192.168.1.255  Mask:255.255.254.0
          inet6 addr: 240e:3b3:30b0:d371::9b3/128 Scope:Global
          inet6 addr: fe80::8ef9:57ff:fe60:15dc/64 Scope:Link
          inet6 addr: 240e:3b3:30b0:d371:8ef9:57ff:fe60:15dc/64 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:38410 errors:0 dropped:12 overruns:0 frame:0
          TX packets:1522 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:7210187 (6.8 MiB)  TX bytes:152719 (149.1 KiB)
          Interrupt:53 Base address:0x8000
```

inet addr: Ethernet IP.

- Get the current backhaul network interface

```
$> netbackhaul 
eth0
```

- Get version revision records

```
$> get_changelog 
## 1.0.0
- Initial version
```

### 8.2 Backup lithium battery (optional)

- Backup lithium battery voltage ADC sampling

Sample backup lithium battery voltage ADC, ranging from 0 to 255.

```
$> /usr/local/battery/batadc.sh 
243
```

The collected ADC value is converted to the corresponding lithium battery voltage by the formula `(ADC / 255.0 * 3.3) / (45.3 / (45.3 + 100))`. If the above ADC value is 243, then the voltage of the lithium battery at this time is `(243 / 255.0 * 3.3) / (45.3 / (45.3 + 100)) = 10.09V`.

When the battery is not connected, the range of ADC sampling is 0~140. Users can judge whether a lithium battery is connected through this range.

**Note: Lithium battery ADC sampling should not be too frequent, otherwise it will affect the charging efficiency of lithium battery. It is recommended that each sampling interval should be >=5 minutes. **

- Backup lithium battery power

Get the percentage of lithium battery power.

```
$> /usr/local/battery/calpow
98
```

**Note: Do not get the lithium battery power too frequently, otherwise it will affect the charging efficiency of the lithium battery. It is recommended that each sampling interval should be >=5 minutes.**

### 8.3 Set network priority

When there are multiple backhaul networks on the device, the user knows which backhaul network is more stable and can choose their own network priority.

- Query network optimization level

```
$> netpriority 
eth
```

eth: The Ethernet backhaul network optimization level is the highest. Default eth.

lte: The 4G backhaul network optimization level is the highest.

wifi: The WiFI backhaul network optimization level is the highest.

- Set the highest network optimization level

```
$> netpriority eth
```

### 8.4 Set static IP

When the device is connected to the network cable, it obtains the IP address dynamically assigned by the upper-level router through DHCP by default. If the user needs to set a static IP, use the `setip` command to set a static IP.

The following is the help manual for `setip`.

```
$> setip -h
Usage: setip [options]

Options:
  --help                  Show this help
  --mode      <MODE>      IP mode(dhcp, static)
  --addr      <ADDR>      IP addr
  --gateway   <GATEWAY>   IP GATEWAY
  --dns0      <DNS0>      nameserver0
  --dns1      <DNS1>      nameserver1

Examples:
  setip
  setip --mode dhcp
  setip --mode static --addr ADDR --gateway GATEWAY --dns0 DNS0 --dns1 DNS1
```

### 8.5 Set ntp server

Set NTP server, user `setntp` command manages own NTP server. There can only be up to 5 NTP servers at the same time.

The following is the help manual for `setntp`.

```
$> setntp -h
Usage: setntp [options] server

Options:
  --help                  Show this help
  --top     <TOPSERVER>   Top server

Examples:
  setntp SERVER
  setntp --top TOPSERVER
  setntp --top TOPSERVER SERVER
```

--top: Put the NTP server on top, and this NTP server has the highest priority.

### 8.6 LTE

The device is embedded with a system service called LTE, which starts with the system by default.

Features:

1. Can automatically identify the sim card and generate APN information
2. Support sim card hot plug operation
3. Support roaming function

- View LTE dialup logs

```
$> cat /var/rlog/lte.log
```

For specific log analysis, please refer to the [LTE dial-up log] chapter.

- Confirm whether the dial-up is successful through the LTE interface

```
$> ifconfig ppp0
ppp0      Link encap:Point-to-Point Protocol  
          inet addr:10.217.214.159  P-t-P:10.64.64.64  Mask:255.255.255.255
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:4 errors:0 dropped:0 overruns:0 frame:0
          TX packets:9 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:3 
          RX bytes:52 (52.0 B)  TX bytes:246 (246.0 B)
```

When the above log is returned, it means the dial-up is successful

- Reset 4G module

```
$> lterst
```

After the 4G module is reset, it takes about 20 seconds to work normally.

- Check if the sim card is inserted

```
$> ltesim
ltesim: lte sim start
ltesim: OK, SIM inserted
ltesim: lte sim done
```

- Get the current network signal quality

```
$> lterssi
lterssi: lte rssi start
lterssi: OK, -61
lterssi: lte rssi done
```

- Get the IMEI code of the device

```
$> lteimei
lteimei: lte imei start
lteimei: OK, 862819048837595
lteimei: lte imei done
```

- Get sim card IMSI

```
$> lteimsi
lteimsi: lte imsi start
carrier: �联�通�物�联�网 (China Unicom) IoT
carrier: �联�通�物�联�网 (China Unicom) IoT
carrier: �联�通�物�联�网 (China Unicom) IoT
lteimsi: OK, 460061185038354
lteimsi: lte imsi done
```

- Get sim card iccid

```
$> lteiccid
lteiccid: lte iccid start
lteiccid: OK, 89860619050022383540
lteiccid: lte iccid done
```

- LTE diagnosis

```
$> ltediagnosis
ltediagnosis: lte diagnosis start
ltediagnosis: OK, lte modem normal
ltediagnosis: OK, usb bus normal
ltediagnosis: OK, SIM inserted
ltediagnosis: OK, rssi is -61
carrier: �联�通�物�联�网 (China Unicom) IoT
carrier: �联�通�物�联�网 (China Unicom) IoT
carrier: �联�通�物�联�网 (China Unicom) IoT
ltediagnosis: OK, imsi is 460061185038354
ltediagnosis: lte diagnosis done
```

- Enable lte service

LTE is enabled by default

```
$> systemctl enable lte && systemctl restart lte
```

- Disable lte service

```
$> systemctl disable lte; systemctl stop lte
```

- Find APN

Users can use the `selapn` command to query whether the device already has the APN of the card according to the APN information of their sim card. If not, add the APN of the card through addapn, and use `selapn --help` to get the help information of the command.

```
$> selapn --help
Usage: selapn [options]

Options:
  --help                  Show this help
  --carrier <CARRIER>     Select carrier name
  --mcc <MCC>             Select carrier mcc
  --mnc <MNC>             Select carrier mnc
  --apn <APN>             Select carrier apn

Examples:
  selapn
  selapn --carrier CARRIER --mcc MCC --mnc MNC --apn APN
```

- Add APN

The device system already contains the APN configuration of most of the world's mainstream operators. But users can also add more APN configuration information through the `addapn` command. Use `addapn --help` to get help information for using this command.

```
$> addapn --help
Usage: addapn [options]

Options:
  --help                  Show this help
  --carrier <CARRIER>     Set carrier name
  --mcc <MCC>             Set carrier mcc
  --mnc <MNC>             Set carrier mnc
  --apn <APN>             Set carrier apn
  --user <USER>           Set apn user
  --pwd <PWD>             Set apn pwd

Examples:
  addapn --carrier CARRIER --mcc MCC --mnc MNC --apn APN --user USER --pwd PWD
  addapn --carrier CARRIER --mcc MCC --mnc MNC --apn APN
```

- Delete APN

When users want to delete redundant APNs, they can use the `delapn` command, and use `delapn --help` to get the help information of this command.

```
$> delapn --help
Usage: delapn [options]

Options:
  --help                  Show this help
  --carrier <CARRIER>     Delete carrier apn
  --mcc <MCC>             Delete carrier mcc
  --mnc <MNC>             Delete carrier mnc
  --apn <APN>             Delete apn

Examples:
  delapn --carrier CARRIER
  delapn --carrier CARRIER --mcc MCC --mnc MNC
  delapn --carrier CARRIER --apn APN
```

### 8.7 LoRa

- Reset LoRa

The device provides a hardware reset LoRa command. It is recommended that users use the hardware reset before using LoRa to avoid problems such as program execution failure.

```
$> gwrst
```

### 8.8 Noise Scanning

The device has a built-in noise floor analysis engine, which can help users scan and analyze the environmental floor noise on site, and customers can find interference signals and noises in advance when deploying on site. In order to realize network optimization and avoid channel frequencies with strong interference. **Note: Before using the background noise scanning, the LoRa service must be turned off first. **

The operation of the noise floor scanning function is very simple, you only need to fill in the start frequency point and stop frequency point in the command parameters. The default step is 200000HZ, the number of samples is 2000, the rssi_offset RHF2S209xxx-470 series gateway compensation is -17dB, the RHF2S209xxx-868 series gateway compensation is -7dB, and the rssi_offset RHF2S209xxx-915 series gateway compensation is -15dB. The wider the bandwidth of the scan, the longer it will take. It is generally recommended to scan only 2MHz or 5MHz to cover the target working frequency band. **Note: Due to hardware reasons, RHF2S209xxx-470 series can only scan 470~490Mhz, RHF2S209xxx-868 series can only scan 862~876Mhz, RHF2S209xxx-915 series can only scan 902~928Mhz. **

```
$> cd /usr/local/lora/ && ./spectral_scan -f 471 -F 472
==
== Spectral Scan: start_freq_hz=471000000Hz, end_freq_hz=472000000HZ, step_hz=200000HZ, nb_channels=6, nb_scan=2000, rssi_offset=-11dB
==
Opening SPI communication interface
Note: chip version is 0x10 (v1.0)
INFO: using legacy timestamp
ARB: dual demodulation disabled for all SF
SX1261: PRAM version: SX1261 V2D 2D02
SX1261: PRAM version: SX1261 V2D 2D06
471000000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1792 208 0 0 0 
471200000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1746 254 0 0 0 
471400000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1758 242 0 0 0 
471600000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1789 211 0 0 0 
471800000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1758 242 0 0 0 
472000000: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 34 1949 17 0 0 0 
Closing SPI communication interface
```

The scanned results show a horizontal peak wave, and the point with a higher peak wave has a higher noise floor ratio. First, the numbers in the first column of each row to `:` are the frequency points to be scanned. Starting from the back of `:`, each column of numbers represents the RSSI of the scanned noise floor, and there are 33 groups in total. The first value is rssi_offset compensation value -17dB, then each group has a difference of 4dB, and the RSSI of the last two groups is the same. As shown below, due to space issues, some meaningless values have been deleted in the middle.

```
#Frequency -17 -21 -25 -29 -33 ... -101 -105 -109 -113 -117 -121 -125 -129 -133 -137 -141 -141
471000000:  0   0   0   0   0        0    0    0    0    0    0    0  1792 208    0    0    0 # The noise floor of 471000000 frequency points is concentrated at -129dB
471200000:  0   0   0   0   0        0    0    0    0    0    0    0  1746 254    0    0    0 
471400000:  0   0   0   0   0  	     0    0    0    0    0    0    0  1758 242    0    0    0 
471600000:  0   0   0   0   0        0    0    0    0    0    0    0  1789 211    0    0    0 
471800000:  0   0   0   0   0        0    0    0    0    0    0    0  1758 242    0    0    0 
472000000:  0   0   0   0   0        0    0    0    0    0    0    34 1949  17    0    0    0 # 472000000 The noise floor is higher than other frequency points
```

For more configuration parameters of noise scanning, please refer to the help manual `./spectral_scan -h`

```
$> ./spectral_scan -h
Library version information: Version: 1.0.0;
Available options:
 -h         Print this help
 -f <float> Scan start frequency, in MHz
 -F <float> Scan end frequency, in MHz
 -e <float> frequency step, in KHz
 -n <uint>  Number of channels to scan
 -s <uint>  Number of scan points per frequency step [1..65535]
 -o <int>   RSSI Offset of the sx1261 path, in dB [-127..128]
 -l <char>  Log file name
```

Environmental noise floor is an important index parameter affecting wireless communication. If you need to erect and install the gateway on site, be sure to do a preliminary analysis of the environmental noise on site, so as not to affect the communication distance and reliability due to high noise or strong interference. We hope that the environmental noise is as low as possible, but the real environment cannot be completely free of interference or noise. It is generally recommended that the ambient noise floor is around -110dBm, which is ideal. Usually the maximum noise is allowed not to exceed -100dBm, otherwise the communication distance will be severely limited. If the noise is above -95dBm, it is strongly recommended to change the working frequency band to avoid interference noise.

### 8.9 lora_service

The gateway integrates many LoRa service processes, but LoRa only allows one process to occupy it, that is, all LoRa-related processes are mutually exclusive, but there is no relationship between processes. How can users avoid this? What's the problem?

The gateway encapsulates a lora_service process based on systemd. Users use systemd to manage their own LoRa-related processes and register the service to lora_service. Then this process can be mutually exclusive with other LoRa processes.

The following uses the standard packet_forwarder as an example to explain. The relevant programs of packet_forwarder are placed in /opt/pktfwd, and this directory is also its working directory. The normal startup method is undoubtedly to execute `./lora_pkt_fwd`, but if there are other related LoRa service processes running at the same time, Unexpected problems such as startup failure or inability to receive data may occur.

Therefore, it is recommended to use systemd’s self-starting service to start the process by adding the xxx.service (xxx represents the name chosen by the user at will, but cannot be repeated with other files) file in the /lib/systemd/system directory. The following explains how to start the service of the service file of the standard packet_forwarder process.

 ```
 $> cat /lib/systemd/system/pktfwd.service
 [Unit]
 Description=Semtech LoRa packet forwarder # The server description information
 After=initonce.service
 After=network.target # Start this service after network service
 
 [Service]
 Restart=always # The action of restarting after the process exits
 RestartSec=60 # With Restart, the process restarts after exiting for 60 seconds
 WorkingDirectory=/opt/pktfwd # working directory of the process
 ExecStartPre=/usr/local/sbin/web_select_lora_freq --name pktfwd # Set the web interface state before starting the final process
 ExecStartPre=/usr/local/lora/lora_service -c /usr/local/lora/.lora_service.json -fpktfwd # Mutually exclude other LoRa service processes before starting the final process
 ExecStartPre=/usr/local/sbin/gwrst # Execute the process before starting the final process
 ExecStartPre=/usr/local/sbin/gwrst1 # Execute the process before starting the final process
 ExecStart=/opt/pktfwd/lora_pkt_fwd # The process that was finally launched
 
 [Install]
 WantedBy=multi-user.target 
 ```

The above briefly introduces how to start a LoRa service process. The user can see in pktfwd.service that the reason to execute `/usr/local/lora/lora_service -c /usr/local/lora/.lora_service.json -fpktfwd` command before starting the final process is because the command It is to play the role of mutual exclusion of other processes. The -f parameter means that except for the pktfwd process, all other processes (other processes here are processes registered to lora_service) are stopped.

Use `lora_service -h` to view related usage instructions.

```
$> lora_service -h

Available options:
 -h                   print this help
 -c <file>            load config file
 -a <str>             add(replace) lora service
 -d <str>             del lora service
 -l                   list lora service
 -q                   query use lora service
 -s [str]             stop lora service
 -f [str]             filter stop lora service
 -t [str]             temporary stop lora service
 -r <str>             restart/start lora service
 -T <str>             temporary restart/start lora service

Example:
 lora_service -a '{"service_name":["service1.service","service2.service",...]}'
 lora_service -d service_name
 lora_service -l
 lora_service -q
 lora_service -s [service_name]
 lora_service -f [service_name]
 lora_service -t [service_name]
 lora_service -r service_name
 lora_service -T service_name
```

- View registered LoRa services

```
$> lora_service -l
loraserver
        loraserver-bridge.service
        loraserver-pktfwd.service
pktfwd
        pktfwd.service
iotsquare
        iotsquare-pktfwd.service
```

The system has registered three LoRa services: pktfwd, iotsquare and loraserver by default.

pktfwd uses pktfwd.service to configure the hosted LoRa service. Similarly, iotsquare uses iotsquare-pktfwd.service to configure hosted LoRa services, while loraserver uses loraserver-bridge.service and loraserver-pktfwd.service to configure hosted LoRa services.

- Register LoRa service

```
$> lora_service -a '{"service_name":["service1.service","service2.service",...]}' 
```

service_name and xxx.service cannot be the same as the registered LoRa service.

- Unregister of the LoRa service

```
lora_service -d "service_name"
```

- Query the service in use

```
$> lora_service -q
service_name
```

- Stop the LoRa service

```
$> lora_service -s
```

Users can stop it without knowing which LoRa service is being used.

- Skip this LoRa service, disable other LoRa services

```
lora_service -f"service_name"
```

- Start the specified LoRa service

```
lora_service -r "service_name"
```

The above service_name represents the user-defined LoRa service name.

### 8.10 Temperature Sensor

A high-precision temperature sensor is integrated inside the device, which can monitor the internal ambient temperature of the device in real time. You can use the command `get_temp` to query the internal temperature in real time, but the user integrates it into the program to execute it, and try to control the collection cycle of more than one minute, because there are multiple monitoring processes in the system that use this command, and frequent use will cause the CPU usage of the device The rate is high.

```
$> get_temp
22.06
```

### 8.11 Modify time zone

- Query the time zone supported by the system

```
/usr/bin/timedatectl list-timezones
```

- Modify time zone

```
$> timedatectl set-timezone Asia/Shanghai
```

Such as: change to `Asia/Shanghai` time zone

### 8.12 System startup is performed only once

The commands in the `/etc/initonce.d/` directory are only executed once when booting. If the execution is successful (command returns 0), the system will delete the command, and the command will not be executed next time the system starts. If the execution fails (command returns non-zero), the system will still execute it next time. It is suitable for configurations that are executed only once when the user boots up.

### 8.13 Report network status interface

When the routing path of the backhaul network changes, the system will execute all commands in the `/etc/route-call.d` directory. Two variables `ROUTE_BEFOR` and `ROUTE_CURR` are exposed, which represent the previous routing path and the current routing path respectively. It is suitable for users to monitor whether the network routing path changes.

### 8.14 Report external power status interface

When the state of the external power supply changes, the system will execute all the commands in the `/etc/power-call.d/` directory. Two variables `NAME` and `STATE` are exposed, which represent the name and current state of the external power supply respectively. Suitable for users to monitor whether the status of external power supply has changed.

### 8.15 Report backup lithium battery status interface

When the status of the backup lithium battery changes, the system will execute all commands in the `/etc/battery-call.d/` directory. Two variables `BAT_BEFOR` and `BAT_CURR` are exposed, which respectively represent the previous state and current state of the backup lithium battery. It is suitable for users to monitor whether the status of the backup lithium battery has changed.

Because the backup lithium battery uses polling to capture status changes, all commands in the `/etc/battery-call. Status record. The external power supply uses interrupts to capture state changes, so there is no such thing as a lithium battery.

### 8.16 WiFi

The WiFi AP service is mainly used for near-field wireless debugging for users.

- Enable WiFi AP service

WiFi AP service is enabled by default.

```
$> openap
```

- Disable WiFi AP service

If the user does not want people to connect to the WiFi AP for security reasons, he can use the `closeap` command to close it.

```
$> closeap
```

- Display WiFi SSID

WiFi SSID is displayed by default.

```
$> waphidden --hidden 0
```

- Hide WiFi SSID

For security reasons, if the user does not want the WiFi SSID to be scanned, he can use the `waphidden` command to hide it.

```
$> waphidden --hidden 1
```

- Get WiFi SSID

```
$> wapgetssid
RHF2S209_6015DC
```

- Modify WiFi AP configuration

Users modify the configuration of WiFi AP through `wapset`, including gateway address, SSID, password and whether to hide SSID.

The following is the help manual for `wapset`.

```
$> wapset -h
Usage: wapset [options]

Options:
  --help                  Show this help
  --addr     <ADDRESS>    Set gateway address
  --ssid     <SSID>       Set ssid
  --pwd      <PWD>        Set wpa_passphrase
  --hidden   <HIDE>       Hidden ssid(0 not hidden, 1 hidden)

Examples:
  wapset --ssid SSID --pwd PWD --hidden 0
  wapset --addr ADDRESS --ssid SSID --pwd PWD  --hidden 0
```

### 8.17 web interface service

The web interface service is the built-in web interface of the device. Use the IP of the device to open the web interface through a browser. For specific usage, refer to the [Built-in web interface] chapter of the User Manual.

- Enable web service

The web service is turned on by default.

```
$> openweb
```

- Disable web service

If the user does not want people to log in to the web interface for security reasons, he can use the `closeweb` command to close it.

```
$> closeweb
```

### 8.18 debug serial port

- Open the debug serial port

The debug serial port is opened by default.

```
$> openserial
```

- Close the debugging serial port

For security reasons, if the user does not want people to log in to the command terminal through the debugging serial port, you can use the `closeserial` command to close it.

```
$> closeserial
```

### 8.19 ssh management

- open ssh

ssh is turned on by default.

```
$> openssh
```

- close ssh

If the user does not want people to log in to the command terminal through ssh for security reasons, the `closessh` command can be used to close it.

```
$> closessh
```

## 9 device log

RHF2S209 has two log output directories, namely /var/log and /var/rlog directories. The difference between these two log directories is mainly reflected in whether the logs are cleared after the device restarts. The /var/log directory mainly stores system logs. The logs will be cleared after the device restarts. It is commonly known as non-persistent logs. It saves more output logs and not particularly important logs. The /var/rlog directory mainly stores logs related to key processes, which will not be affected by device restarts. It is commonly known as persistent logs. It saves not many output logs and is particularly important, which is convenient for viewing the status of the device in the future.

### 9.1 /var/log (non-persistent log)

The non-persistent log can save up to 246M. When it is larger than 246M, it can no longer be written into the log, but it will not affect the use of the program. Of course, the device will cut the log regularly to ensure that the non-persistent log of the device will not exceed 246M.

#### 9.1.1 kernel log

/var/log/kern.log, which records the log of kernel operation, including the status information of kernel operation, which can be used by users to analyze the operation status of the device system.

#### 9.1.2 syslog log

/var/log/syslog, records logs such as kernel logs, systemd logs, and process standard error output, including almost all logs of the system.

#### 9.1.3 pktfwd log

/var/log/pktfwd.log, record the log of LoRa (if pktfwd does not open the log or the process is not started, the log may not exist). **Note: Logs are not recorded in real time. **

##### 9.1.3.1 stat package

The following logs belong to the pktfwd stat package, and pktfwd will report the stat package periodically. Users can modify the stat packet reporting interval through the gateway_conf.stat_interval option in the global_conf.json or local_conf.json file.

```
7 2022-11-15T00:00:17.264461Z   PKTFWD:929    time 49354473, frame PUSH_DATA, 02, 4026, 00, 8CF957FFFE6017E5, {"stat":{"time":"2022-11-15 00:00:17 GMT","lati":0,"long":0,"alti":0,"rxnb":6,"rxok":6,"rxfw":6,"ackr":100,"dwnb":6,"txnb":6,"gtss":2}} // Uplink a stat package
6 2022-11-15T00:00:17.266221Z   PKTFWD:402    PUSH_ACK (4026) received in 2 ms
7 2022-11-15T00:00:17.266294Z   PKTFWD:945    time 49354475, frame PUSH_ACK, 02, 4026, 01
```

The stat json object contains the status of the gateway and has the following fields:

![image-20230216181442321](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/aa9b249081aff5c47e2dfce5a3939f7d.png)

##### 9.1.3.2 LoRaWAN uplink and downlink data packets

The following logs belong to LoRaWAN uplink and downlink data. Among them, the rxpk json packet belongs to the uplink data packet, and the data belongs to the data obtained by encrypting and base64 encoding the node application data. Users mainly care about the tmst, freq, rssi and lsnr fields. The txpk json packet belongs to the downlink data packet. Users can judge the downlink data sent by the server corresponding to the uplink data according to the tmst (unit: ms) field, because uplink tmst+1s=downlink tmst, such as: rxpk and txpk belong to a pair Uplink and downlink data, because 2105654642+1000000=2106654642. Users mainly care about the tmst and freq fields.

```
7 2022-11-15T00:00:14.949014Z   PKTFWD:929    time 49352158, frame PUSH_DATA, 02, 4025, 00, 8CF957FFFE6017E5, {"rxpk":[{"jver":1,"time":"2022-11-15T00:00:14.877267Z","tmst":2105654642,"rfch":0,"chan":5,"freq":484.9,"mid":8,"stat":1,"modu":"LORA","datr":"SF7BW125","codr":"4/5","rssic":-49,"foff":-315,"rssi":-49,"lsnr":13.5,"size":14,"data":"gMuKxwCAZ/oIkAM5Q+I="}]} // LoRaWAN uplink data packet received
6 2022-11-15T00:00:14.951076Z   PKTFWD:402    PUSH_ACK (4025) received in 2 ms
7 2022-11-15T00:00:14.951147Z   PKTFWD:945    time 49352160, frame PUSH_ACK, 02, 4025, 01
7 2022-11-15T00:00:15.297317Z   PKTFWD:1057   PULL_RESP (4A39) push ok
7 2022-11-15T00:00:15.297470Z   PKTFWD:945    time 49352506, frame PULL_RESP, 02, 4A39, 03, {"txpk":{"imme":false,"tmst":2106654642,"freq":505.3,"rfch":0,"powe":20,"modu":"LORA","datr":"SF7BW125","codr":"4/5","ipol":true,"size":12,"ncrc":true,"data":"YMuKxwCgtvgKimii","brd":0,"ant":0,"nhdr":false}}
7 2022-11-15T00:00:15.297914Z     JITQ:776    enqueue: pkt 2106654642, pre 31500, post 41000, type 0, now 2106075279, delta 579363, qos 5
7 2022-11-15T00:00:15.297990Z     JITQ:799    jit queue packets 1 (beacons: 0, ceacons: 0, downlinks: 1)
7 2022-11-15T00:00:15.298069Z   PKTFWD:929    time 49352507, frame TX_ACK, 02, 4A39, 05, 8CF957FFFE6017E5, {"txpk_ack":{"error":"NONE","jiterr":"NONE"}}
7 2022-11-15T00:00:15.856316Z     JITQ:789    dequeue: pkt 2106654642, pre 31500, post 41000, type 0, now 2106629201, delta 25441, qos 5
7 2022-11-15T00:00:15.856414Z     JITQ:799    jit queue packets 0 (beacons: 0, ceacons: 0, downlinks: 0)
7 2022-11-15T00:00:15.856450Z       RF:1202   LoRa0: lgw_send, enter 2106629201, exit 2106633681, packet 2106654642, cost 4480, diff 20961, api 4460us, lock 4463us, peek 1us, deq 5us, gps 3us, poll 5047, dly 5039
```

The rxpk json object contains the upstream data of the gateway and has the following fields:

![image-20230216182016162](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/9eb8e912bfdb30efcc7deea9f5924da3.png)

The txpk json object contains the downstream data of the gateway and has the following fields:

![image-20230216182058738](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/4874761c2b27350f95bb7d7e7590e385.png)

#### 9.1.4 rhf-bridge log

/var/log/bridge.log, record the log of rhf-birdge (if rhf-bridge does not enable the log or the process is not started, the log may not exist).

#### 9.1.5 other logs

The system also includes access, verification, cutting, web interface and other logs, which will not be explained here.

#### 9.1.6 View the specified service log

### 9.2 /var/rlog (persistent log)

The storage size of the persistent log is equal to the remaining space of the eMMC. Generally, 5 to 6 Gbytes can be saved. However, when the remaining space of the eMMC is insufficient, the normal use of the program will be affected, so it is necessary to be cautious when saving the persistent log. Of course, the device will cut the log regularly to ensure that the persistent log of the device will not occupy too much eMMC.

#### 9.2.1 ethernet log

/var/rlog/eth.log, when the network status of the three network components of Ethernet, 4G and WiFi changes, the system will generate a line of logs to record the network status of the three components at that time.

```
[2020-09-20 10:44:24+00:00]->[eth0: connected, wlan0: disconnected, wlan1: disconnected]
[2023-02-13 10:42:09+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
[2023-02-13 10:44:59+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
[2023-02-13 10:45:02+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
[2023-02-14 03:06:57+00:00]->[eth0: disconnected, ppp0: connected, wlan1: disconnected]
[2023-02-14 03:24:11+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
[2023-02-15 04:24:17+00:00]->[eth0: connected, wlan1: disconnected, ppp0: disconnected]
[2023-02-15 04:24:23+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
[2023-02-16 05:24:25+00:00]->[eth0: connected, wlan1: disconnected, ppp0: disconnected]
[2023-02-16 05:24:29+00:00]->[eth0: connected, ppp0: connected, wlan1: disconnected]
```

#### 9.2.2 LTE Dial-up Log

/var/rlog/lte.log, record all logs of LTE dial-up.

##### 9.2.2.1 Example of successful dialing

When the log prompts "dial success", it means the dialing is successful.

```
[2020-09-20 10:44:17+00:00]->[ltestart: start dial]
[2023-02-13 10:42:00+00:00]->[ltestart: OK, SIM inserted]
[2023-02-13 10:42:00+00:00]->[ltestart: OK, 89860619050022383540]
[2023-02-13 10:42:00+00:00]->[automatically operators mode]
[2023-02-13 10:42:01+00:00]->[ltestart: APN information: �联�通�物�联�网 (China Unicom) IoT,460,06,unim2m.bjm2mapn,,] // Dial APN Details
timeout set to 15 seconds
abort on (DELAYED)
abort on (BUSY)
abort on (ERROR)
abort on (NO DIALTONE)
abort on (NO CARRIER)
send (AT^M)
expect (OK)
AT^M^M
OK
 -- got it

send (AT+CREG?^M)
expect (OK)
^M
AT+CREG?^M^M
+CREG: 0,1^M
^M
OK
 -- got it

send (AT+COPS?^M)
expect (OK)
^M
AT+COPS?^M^M
+COPS: 0,0,"CHN-UNICOM",7^M
^M
OK
 -- got it

send (AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M) // unim2m.bjm2mapn is dial-up APN
expect (OK)
^M
AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M^M
OK
 -- got it

send (ATD*99#^M)
expect (CONNECT)
^M
ATD*99#^M^M
CONNECT
 -- got it

send (^M)
Serial connection established.
Using interface ppp0
Connect: ppp0 <--> /dev/ltemodem
Could not determine remote IP address: defaulting to 10.64.64.64
not replacing default route to eth0 [192.168.0.1]
local  IP address 10.212.96.167 // Obtaining the operator's IP means that the dial-up is successful, and the IP is not fixed
remote IP address 10.64.64.64
primary   DNS address 210.22.70.3
secondary DNS address 210.22.84.3
[2023-02-13 10:42:07+00:00]->[ltestart: dial success] // Prompt that dialing is successful
[2023-02-13 10:42:08+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -57] // The signal quality of the current network
```

##### 9.2.2.2 Dial without sim card

```
[2023-02-16 08:36:19+00:00]->[ltestart: start dial]
[2023-02-16 08:37:20+00:00]->[ltestart: start dial]
[2023-02-16 08:38:20+00:00]->[ltestart: start dial]
[2023-02-16 08:39:21+00:00]->[ltestart: start dial]
[2023-02-16 08:40:21+00:00]->[ltestart: start dial] // Periodic round robin start dialing
```

##### 9.2.2.3 APN not found

```
[2023-02-16 09:17:29+00:00]->[ltestart: start dial]
[2023-02-16 09:17:30+00:00]->[ltestart: OK, SIM inserted]
[2023-02-16 09:17:30+00:00]->[ltestart: OK, 89860619050022383540]
[2023-02-16 09:17:30+00:00]->[automatically operators mode]
[2023-02-16 09:17:31+00:00]->[ltestart: NG, unsupport 2 bits mnc sim card, 460, 06] // APN not found
[2023-02-16 09:17:31+00:00]->[ltestart: NG, unsupport 3 bits mnc sim card, 460, 061] 
```

##### 9.2.2.4 There is no fee for the sim card/the wrong APN is used/the location of the device has no operator network/the sim card has a binding function

```
[2023-02-16 08:58:41+00:00]->[ltestart: start dial]
[2023-02-16 08:58:43+00:00]->[ltestart: OK, SIM inserted]
[2023-02-16 08:58:44+00:00]->[ltestart: OK, 89860619050022383540]
[2023-02-16 08:58:44+00:00]->[automatically operators mode]
[2023-02-16 08:58:45+00:00]->[ltestart: APN information: �联�通�物�联�网 (China Unicom) IoT,460,06,unim2m.bjm2mapn,,]
timeout set to 15 seconds
abort on (DELAYED)
abort on (BUSY)
abort on (ERROR)
abort on (NO DIALTONE)
abort on (NO CARRIER)
send (AT^M)
expect (OK)
AT^M^M
OK
 -- got it

send (AT+CREG?^M)
expect (OK)
^M
AT+CREG?^M^M
+CREG: 0,1^M
^M
OK
 -- got it

send (AT+COPS?^M)
expect (OK)
^M
AT+COPS?^M^M
+COPS: 0^M
^M
OK
 -- got it

send (AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M)
expect (OK)
^M
AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M^M
OK
 -- got it

send (ATD*99#^M)
expect (CONNECT)
^M
ATD*99#^M^M
CONNECT
 -- got it

send (^M)
Serial connection established.
Using interface ppp0
Connect: ppp0 <--> /dev/ltemodem
Modem hangup
Connection terminated. // The first dial-up failed
[2023-02-16 08:58:50+00:00]->[ltestart: modem hangup]
[2023-02-16 08:58:51+00:00]->[ltestart: Retry [0] pppd return 16]
timeout set to 15 seconds
abort on (DELAYED)
abort on (BUSY)
abort on (ERROR)
abort on (NO DIALTONE)
abort on (NO CARRIER)
send (AT^M)
expect (OK)
AT^M^M
OK
 -- got it

send (AT+CREG?^M)
expect (OK)
^M
AT+CREG?^M^M
+CREG: 0,1^M
^M
OK
 -- got it

send (AT+COPS?^M)
expect (OK)
^M
AT+COPS?^M^M
+COPS: 0^M
^M
OK
 -- got it

send (AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M)
expect (OK)
^M
AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M^M
OK
 -- got it

send (ATD*99#^M)
expect (CONNECT)
^M
ATD*99#^M^M
CONNECT
 -- got it

send (^M)
Serial connection established.
Using interface ppp0
Connect: ppp0 <--> /dev/ltemodem
Modem hangup
Connection terminated. // The second dial-up failed
[2023-02-16 08:58:56+00:00]->[ltestart: modem hangup]
[2023-02-16 08:58:56+00:00]->[ltestart: Retry [1] pppd return 16]
timeout set to 15 seconds
abort on (DELAYED)
abort on (BUSY)
abort on (ERROR)
abort on (NO DIALTONE)
abort on (NO CARRIER)
send (AT^M)
expect (OK)
AT^M^M
OK
 -- got it

send (AT+CREG?^M)
expect (OK)
^M
AT+CREG?^M^M
+CREG: 0,1^M
^M
OK
 -- got it

send (AT+COPS?^M)
expect (OK)
^M
AT+COPS?^M^M
+COPS: 0^M
^M
OK
 -- got it

send (AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M)
expect (OK)
^M
AT+CGDCONT=1,"IP","unim2m.bjm2mapn"^M^M
OK
 -- got it

send (ATD*99#^M)
expect (CONNECT)
^M
ATD*99#^M^M
CONNECT
 -- got it

send (^M)
Serial connection established.
Using interface ppp0
Connect: ppp0 <--> /dev/ltemodem
Modem hangup
Connection terminated.  // The third dial-up failed
[2023-02-16 08:59:00+00:00]->[ltestart: modem hangup]
[2023-02-16 08:59:00+00:00]->[ltestart: Retry [2] pppd return 16]
[2023-02-16 08:59:00+00:00]->[ltestart: APN dial failure] // Each APN has three dial-up opportunities, and the next APN will be selected after three failures
```

##### 9.2.2.5 Signal quality

When the dial-up is successful, record the signal quality of the current network every 15 minutes.

```
[2023-02-16 05:24:28+00:00]->[ltestart: dial success]
[2023-02-16 05:24:28+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 05:39:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 05:54:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 06:09:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 06:24:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 06:39:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 06:54:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 07:09:29+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 07:24:30+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53]
[2023-02-16 07:39:30+00:00]->[ltestart: CHN-UNICOM's 7 rssi is -53] // The current network signal quality is -53dbm
```

#### 9.2.3 power log

/var/rlog/pow.log, when the external power supply and backup lithium battery are inserted or pulled out, a line of operation log will be recorded.

Because the backup lithium battery uses polling to capture status changes, a log will be generated every time it is turned on, and if the time interval for changing the status is short, the status record may be lost. The external power supply uses interrupts to capture state changes, so there is no such thing as a lithium battery.

```
[2023-02-13 10:43:45+00:00]->[INFO: plug the battery]
[2023-02-13 10:46:44+00:00]->[INFO: plug the battery]
[2023-02-16 07:49:04+00:00]->[INFO: unplug the battery]
[2023-02-16 07:54:07+00:00]->[INFO: plug the battery]
[2023-02-16 07:56:44+00:00]->[INFO: disconnect to external power supply]
[2023-02-16 07:56:51+00:00]->[INFO: connect to external power supply]
```

#### 9.2.4 Runtime Log

/var/rlog/runtime.log, which records the boot time of the device and the total running time of this boot. The log format it saves is `[Start-up time]->[System running time (unit: second)]`, and the "System running time" is refreshed every 5 minutes, so the error is 0~-5min.

```
[2023-02-13 10:43:45+00:00]->[157.87] // The log records that the device was powered on around 2023-02-13 10:43:45+00:00, and the device shut down after running for 157.87 seconds
[2023-02-13 10:46:46+00:00]->[247848.18] // If the log is the last line of the file, it means that the current device was powered on around 2023-02-13 10:46:46+00:00, and has been running for 247848.18 seconds, and the value will be refreshed in the next 5 minutes
```

#### 9.2.5 temperature log

/var/rlog/temp.log, record the temperature in the device box, and collect the temperature every 15 minutes.

```
[2023-02-13 10:43:46+00:00]->[null] // The first temperature collection value after the device is started is "null", which is mainly used to divide the temperature collected last time and the temperature collected this time
[2023-02-13 10:43:46+00:00]->[28.19]
[2023-02-13 10:46:47+00:00]->[null]
[2023-02-13 10:46:47+00:00]->[28.62]
[2023-02-13 11:01:48+00:00]->[29.69]
[2023-02-13 11:16:48+00:00]->[29.69]
[2023-02-13 11:31:49+00:00]->[29.56]
[2023-02-13 11:46:50+00:00]->[29.38]
```

**Note: Generally, the temperature in the box is about 8°C higher than the current ambient temperature. **

#### 9.2.6 detection log

/var/rlog/det.log, abnormal detection log (if the device has no abnormality, the log may not exist). When the device detects that there is an exception in the device, it will record a line of logs and perform corresponding exception handling.

```
[2023-02-16 07:59:00+00:00]->[The ppp0 cannot ping the server, re-establish] // If the 4G dial-up is successful, but try to ping the specified server for 10 times, and the ping fails once, then the dial-up will be made again. It is common for IoT cards to have a whitelist function, and the mqtt_server in /opt/rhf-bridge/sdk_conf.json needs to be added to the whitelist.
[2023-02-16 08:04:11+00:00]->[The ppp0 cannot ping the server, system ready reboot] // When the sim card is inserted, but the dial-up is always unsuccessful, when the dial-up is unsuccessful for 1000 times, then the device will be restarted. It is common that there is no fee for the sim card/the location of the device has no operator network/the sim card has the binding function.
[2023-02-18 08:07:23+00:00]->[dhcp failed, system ready reboot] // After connecting to the network cable, the IP address cannot be obtained correctly.
```

## 10  troubleshooting

### 10.1 LoRa service process conflict

The LoRa module is an exclusive resource, and the gateway can only be occupied by one program. If multiple programs use the LoRa module at the same time, it will cause unpredictable problems in the gateway LoRa module. Therefore, no matter when using or testing, it is necessary to ensure that the LoRa service module is only run by one program.

At present, the procedures for starting the LoRa service integrated in the gateway system are:

- packet_forwarder
- iotsquare
- loraserver
- LoRa test program

#### 10.1.1 ps

Use the `ps -ef | grep -E "lora_pkt_fwd|pktfwd|loragw|spectral_scan"` command to check whether the system has LoRa service-related programs.

- lora_pkt_fwd is the keyword of packet_forwarder process

- pktfwd is the keyword of iotsquare and loraserver process

- loragw is the keyword of the LoRa test process

If the LoRa module is occupied, two or more records (one of which is the record of its own command) will be returned. The user can determine which process the system is being executed according to the returned process keyword, as shown below, the LoRa module is being occupied by the iotsquare service (for details on how to close the service, please refer to the user manual of the device).

![image-20230216173541129](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/589fdeed067778debb46b452fb7fa6be.png)

#### 10.1.2 Self-developed pktfwd

When the self-developed pktfwd starts, it will check whether the LoRa module has been used. If used, returns an error and exits. Therefore, it can be used to check if the LoRa module has been used.
Execute command: `/opt/pktfwd/lora_pkt_fwd`
If the LoRa module is occupied, an error as shown in the figure below will be output, where (PID xxxx) means that the LoRa module is occupied by the xxxx process. Kill the process with `kill -9 xxxx`. If it is a process started by using the systemd service, then the LoRa service must be closed (please refer to the user manual of the device for how to close the service), otherwise it will be occupied again after a while.

![image-20230216173721470](https://risinghf-wiki.oss-cn-shenzhen.aliyuncs.com/upload/img/7fdc2f09c7d34acca9fd46896c756d96.png)

#### 10.1.3 lora_service

The gateway has customized the lora_service command to host the LoRa service process of the gateway, which can ensure that only one LoRa service process runs at a time, and can also use this command to query and close the running LoRa process.
Query command: lora_service -q
Shutdown command: lora_service -s
For more options, please check the help manual: lora_service -h
**Note: This command cannot query whether the non-lora_service managed LoRa service process is running, such as: LoRa test process. **

### 10.2 LoRa module cannot start normally

When lora_pkt_fwd/pktfwd starts, the following error is prompted. Then you have to check whether the LoRa module hardware is normal.

```
    _/_/_/    _/_/_/    _/_/_/  _/_/_/  _/      _/    _/_/_/  _/    _/  _/_/_/
   _/    _/    _/    _/          _/    _/_/    _/  _/        _/    _/  _/     
  _/_/_/      _/      _/_/      _/    _/  _/  _/  _/  _/_/  _/_/_/_/  _/_/_/  
 _/    _/    _/          _/    _/    _/    _/_/  _/    _/  _/    _/  _/       
_/    _/  _/_/_/  _/_/_/    _/_/_/  _/      _/    _/_/_/  _/    _/  _/        
Create pid file successfully
Search directory /opt/rhf-bridge
Read configuration file /opt/rhf-bridge/global_conf.json
Read configuration file /opt/rhf-bridge/local_conf.json
Read configuration file /opt/rhf-bridge/cal_conf.json
6 2023-02-16T09:46:50.655577Z   PKTFWD:200    tx timeout 100ms, pull data period 30s, keep alive timeout 150s
6 2023-02-16T09:46:50.665383Z       RF:339    LoRa0: Concentrator starting...
7 2023-02-16T09:46:50.665431Z       RF:349    LoRa0: Radio A, 485000000
7 2023-02-16T09:46:50.665463Z       RF:349    LoRa0: Radio B, 485800000
6 2023-02-16T09:46:50.665493Z       RF:359    LoRa0: CH 0, 485500000, -300000
6 2023-02-16T09:46:50.665523Z       RF:359    LoRa0: CH 1, 485700000, -100000
6 2023-02-16T09:46:50.665553Z       RF:359    LoRa0: CH 2, 485900000, 100000
6 2023-02-16T09:46:50.665582Z       RF:359    LoRa0: CH 3, 486100000, 300000
6 2023-02-16T09:46:50.665611Z       RF:359    LoRa0: CH 4, 484700000, -300000
6 2023-02-16T09:46:50.665640Z       RF:359    LoRa0: CH 5, 484900000, -100000
6 2023-02-16T09:46:50.665669Z       RF:359    LoRa0: CH 6, 485100000, 100000
6 2023-02-16T09:46:50.665697Z       RF:359    LoRa0: CH 7, 485300000, 300000
3 2023-02-16T09:46:51.793205Z       RF:369    LoRa0: Concentrator error
2 2023-02-16T09:46:51.793407Z    APPPF:84     rf start failed // 无法启动LoRa模组
```

**Note: Before testing the LoRa module hardware, the LoRa service must be closed first. **

#### 10.2.1 Test spi (hardware related to master control and LoRa module master control)

Execute the `cd /usr/local/lora/ && ./test_loragw_com` command, if the following prompts are printed all the time, it means that the communication between the main control and the LoRa module main control is normal.

```
$> cd /usr/local/lora/ && ./test_loragw_com
Beginning of test for loragw_com.c
Opening SPI communication interface
SX1302 version: 0x10
Cycle 0> did a 175-byte R/W on a data buffer with no error
Cycle 1> did a 1-byte R/W on a data buffer with no error
Cycle 2> did a 498-byte bulk R/W on a data buffer with no error
Cycle 3> did a 764-byte R/W on a data buffer with no error
Cycle 4> did a 1-byte R/W on a data buffer with no error
Cycle 5> did a 480-byte bulk R/W on a data buffer with no error
Cycle 6> did a 545-byte R/W on a data buffer with no error
Cycle 7> did a 1-byte R/W on a data buffer with no error
Cycle 8> did a 301-byte bulk R/W on a data buffer with no error
Cycle 9> did a 763-byte R/W on a data buffer with no error
Cycle 10> did a 1-byte R/W on a data buffer with no error
```

#### 10.2.2 Test SX1250 chip (LoRa RF front-end hardware)

Execute the `cd /usr/local/lora/ && ./test_loragw_com_sx1250` command, if the following prompts are always printed, it means that the communication between the SX1250 and the SX1302 chip is normal.

```
$> cd /usr/local/lora/ && ./test_loragw_com_sx1250 
Opening SPI communication interface
Note: chip version is 0x10 (v1.0)
Radio0: get_status: 0xB2
Radio1: get_status: 0xB2
Cycle 0 > did a 4-byte R/W on a register with no error
Cycle 1 > did a 4-byte R/W on a register with no error
Cycle 2 > did a 4-byte R/W on a register with no error
Cycle 3 > did a 4-byte R/W on a register with no error
Cycle 4 > did a 4-byte R/W on a register with no error
Cycle 5 > did a 4-byte R/W on a register with no error
Cycle 6 > did a 4-byte R/W on a register with no error
Cycle 7 > did a 4-byte R/W on a register with no error
```

#### 10.2.3 Test SX1261 chip (noise floor scanning hardware)

Execute the `cd /usr/local/lora/ && ./test_loragw_com_sx1261` command, if the following prompts are printed all the time, it means that the communication between the main control and the SX1261 chip is normal.

```
$> cd /usr/local/lora/ && ./test_loragw_com_sx1261 
Opening SPI communication interface
Note: chip version is 0x10 (v1.0)
SX1261: get_status: 0xA2
Cycle 0 > did a 4-byte R/W on a register with no error
Cycle 1 > did a 4-byte R/W on a register with no error
Cycle 2 > did a 4-byte R/W on a register with no error
Cycle 3 > did a 4-byte R/W on a register with no error
Cycle 4 > did a 4-byte R/W on a register with no error
Cycle 5 > did a 4-byte R/W on a register with no error
Cycle 6 > did a 4-byte R/W on a register with no error
Cycle 7 > did a 4-byte R/W on a register with no error
Cycle 8 > did a 4-byte R/W on a register with no error
Cycle 9 > did a 4-byte R/W on a register with no error
Cycle 10 > did a 4-byte R/W on a register with no error
```

#### 10.2.4 Test SX1302 (LoRa module master)

Execute `cd /usr/local/lora/ && ./test_loragw_reg`command, if the following prompt is printed, it means that the SX1302 chip is normal.

```
$> cd /usr/local/lora/ && ./test_loragw_reg
Opening SPI communication interface
Note: chip version is 0x10 (v1.0)
## TEST#1: read all registers and check default value for non-read-only registers
------------------
 TEST#1 PASSED
------------------

## TEST#2: read/write test on all non-read-only, non-pulse, non-w0clr, non-w1clr registers
------------------
 TEST#2 PASSED
------------------

Closing SPI communication interface
```

**If all the above tests pass, then the LoRa module hardware is normal.**

### 10.3 test GPS

The user turns on the packet_forwarder beacon, but the node cannot switch to the class B mode. At this time, it is necessary to confirm whether the GPS signal quality is poor.

**Note: Before testing GPS, the LoRa service must be turned off first.**

#### 10.3.1 Test GPS module

Execute `gps -t`, return OK means the communication between the main control and the GPS module is normal, and NG means there is a problem with the hardware.

```
$> gps -t
OK
```

**Note: If the user does not close the LoRa service and the LoRa service is using the GPS module, it may return NG.**

#### 10.3.2 GPS to get geographic location

```
$> gps --gl 1
22.547961,N,113.936117,E
```

#### 10.3.3 GPS to obtain timing and number of satellites

```
$> gps -v
b5620120100048946207d03e0500ca08120732000000a6f2
GSP INFO: [atomic time:1360923901], [utc time:2023-02-20T10:24:42], [latitude:22.547981], [longitude:113.936074], [altitude:36.7], [svnum:6]
$GPRMC,102443.00,A,2232.87874,N,11356.16432,E,0.855,,200223,,,A*7E
$GPVTG,,T,,M,0.855,N,1.584,K,A*23
$GPGGA,102443.00,2232.87874,N,11356.16432,E,1,06,1.26,36.6,M,-2.7,M,,*73
$GPGSA,A,3,19,17,30,03,14,06,,,,,,,2.78,1.26,2.48*09
$GPGSV,3,1,12,01,17,038,,03,42,068,18,04,00,120,,06,45,255,18*7D
$GPGSV,3,2,12,07,05,173,,09,03,151,,11,10,235,,14,86,099,20*7F
$GPGSV,3,3,12,17,47,352,22,19,32,314,22,30,25,205,16,40,20,257,*76
$GPGLL,2232.87874,N,11356.16432,E,102443.00,A,A*6E
```

If you want to use the packet_forwarder beacon function normally, `svnum` must be at least 5 stars or above.

**If all the above tests are passed, then the GPS module of the gateway is normal and the GPS signal quality is good.**
